<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Manager - Reyan Makes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #5a67d8;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        /* Buttons */
        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: white;
            color: var(--primary);
        }

        .btn-primary:hover:not(:disabled) {
            background: #f1f5f9;
            transform: translateY(-1px);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-outline {
            background: transparent;
            color: white;
            border: 2px solid rgba(255,255,255,0.5);
        }

        .btn-outline:hover {
            background: rgba(255,255,255,0.1);
        }

        .btn-publish {
            background: #8b5cf6;
            color: white;
        }

        .btn-publish:hover:not(:disabled) {
            background: #7c3aed;
        }

        /* Auth Section */
        .auth-overlay {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .auth-overlay.hidden {
            display: none;
        }

        .auth-card {
            background: white;
            padding: 2.5rem;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 400px;
        }

        .auth-card h2 {
            margin-bottom: 0.5rem;
            font-size: 1.5rem;
        }

        .auth-card p {
            color: var(--text-light);
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .auth-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        /* Main Layout */
        .main-content {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
            gap: 1.5rem;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            flex-shrink: 0;
            position: relative;
            min-width: 60px;
            max-width: 500px;
        }

        .sidebar-resizer {
            position: absolute;
            top: 0;
            right: -4px;
            width: 8px;
            height: 100%;
            cursor: ew-resize;
            background: transparent;
            z-index: 10;
        }

        .sidebar-resizer:hover,
        .sidebar-resizer.dragging {
            background: var(--primary);
            opacity: 0.5;
            border-radius: 4px;
        }

        .sidebar.collapsed .project-info,
        .sidebar.collapsed .project-list-actions,
        .sidebar.collapsed .featured-order-panel {
            display: none;
        }

        .sidebar.collapsed .project-list-header span {
            display: none;
        }

        .sidebar.collapsed .project-item {
            justify-content: center;
            padding: 0.5rem;
        }

        .sidebar.collapsed .project-thumb {
            width: 40px;
            height: 40px;
        }

        .project-list {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .project-list-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .project-item {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .project-item:hover {
            background: #f8fafc;
        }

        .project-item.active {
            background: #eef2ff;
            border-left: 3px solid var(--primary);
        }

        .project-item:last-child {
            border-bottom: none;
        }

        .project-thumb {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            object-fit: cover;
            background: var(--border);
        }

        .project-info {
            flex: 1;
            min-width: 0;
        }

        .project-info h4 {
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .project-info span {
            font-size: 0.75rem;
            color: var(--text-light);
        }

        .featured-badge {
            background: var(--warning);
            color: white;
            font-size: 0.65rem;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-weight: 600;
        }

        .empty-badge {
            background: var(--text-muted);
            color: white;
            font-size: 0.65rem;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-weight: 600;
        }

        .empty-project {
            opacity: 0.7;
            border-left: 3px solid var(--text-muted);
        }

        .empty-gallery-message {
            grid-column: 1 / -1;
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
            font-style: italic;
        }

        /* Section dividers in project list */
        .section-divider {
            padding: 0.5rem 1rem;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-light);
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-divider.featured {
            background: linear-gradient(135deg, #fef3c7, #fef9c3);
            color: #92400e;
        }

        /* Star toggle button */
        .star-toggle {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            color: #d1d5db;
            transition: all 0.2s;
        }

        .star-toggle:hover {
            color: #f59e0b;
            transform: scale(1.2);
        }

        .star-toggle.active {
            color: #f59e0b;
        }

        /* Drag handle for featured items */
        .drag-handle {
            cursor: grab;
            color: var(--text-light);
            padding: 0.25rem;
        }

        .project-item.dragging {
            opacity: 0.5;
        }

        /* Template Selector Panel */
        .template-panel {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-top: 1rem;
            overflow: hidden;
        }

        .template-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #8b5cf620, #8b5cf605);
        }

        .template-header span:first-child {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .template-grid {
            padding: 0.75rem;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .template-card {
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid var(--border);
            background: white;
            text-align: center;
        }

        .template-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .template-card.active {
            border-color: var(--primary);
            background: #667eea10;
        }

        .template-preview {
            height: 32px;
            border-radius: 4px;
            margin-bottom: 0.4rem;
            display: flex;
            overflow: hidden;
        }

        .template-preview .color-bar {
            flex: 1;
        }

        .template-name {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text);
            text-transform: capitalize;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            min-width: 0;
        }

        .panel {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
        }

        .panel-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header h3 {
            font-size: 1.1rem;
        }

        .panel-body {
            padding: 1.5rem;
        }

        /* Metadata Editor */
        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .metadata-grid .full-width {
            grid-column: 1 / -1;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        /* Gallery Grid */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }

        .gallery-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
            background: var(--border);
        }

        .gallery-item:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }

        .gallery-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .gallery-item.drag-over {
            transform: scale(1.05);
            border: 2px dashed var(--primary);
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gallery-item-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 0.5rem;
            background: linear-gradient(transparent, rgba(0,0,0,0.7));
            color: white;
            font-size: 0.7rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .gallery-item:hover .gallery-item-overlay {
            opacity: 1;
        }

        .gallery-item-index {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            background: rgba(0,0,0,0.6);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .gallery-item-delete {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: var(--danger);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            z-index: 10;
        }

        .gallery-item:hover .gallery-item-delete {
            opacity: 1;
        }

        .gallery-item-delete:hover {
            transform: scale(1.1);
            background: #dc2626;
        }

        .gallery-item-hide {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--warning);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            z-index: 10;
        }

        .gallery-item:hover .gallery-item-hide {
            opacity: 1;
        }

        .gallery-item-hide:hover {
            transform: translate(-50%, -50%) scale(1.1);
            background: #d97706;
        }

        .gallery-item.hidden-image {
            opacity: 0.4;
        }

        .gallery-item.hidden-image::after {
            content: 'HIDDEN';
            position: absolute;
            top: 0.25rem;
            left: 0.25rem;
            transform: none;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 0.15rem 0.35rem;
            border-radius: 4px;
            font-size: 0.6rem;
            font-weight: 600;
            z-index: 5;
        }

        .gallery-item.hidden-image .gallery-item-hide {
            opacity: 1;
            background: var(--success);
            /* Move to center for hidden images - easier to click "show" */
            top: 50%;
            left: 50%;
            right: auto;
            transform: translate(-50%, -50%);
            width: 36px;
            height: 36px;
            z-index: 15;
        }

        /* Upload Drop Zone */
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 1.5rem;
            transition: all 0.2s;
            cursor: pointer;
            background: var(--bg);
        }

        .upload-zone:hover {
            border-color: var(--primary);
            background: #f0f4ff;
        }

        .upload-zone.drag-over {
            border-color: var(--success);
            background: #ecfdf5;
            transform: scale(1.01);
        }

        .upload-zone.uploading {
            opacity: 0.7;
            pointer-events: none;
        }

        .upload-zone svg {
            width: 48px;
            height: 48px;
            color: var(--text-light);
            margin-bottom: 1rem;
        }

        .upload-zone h4 {
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .upload-zone p {
            font-size: 0.85rem;
            color: var(--text-light);
            margin: 0;
        }

        .upload-zone input[type="file"] {
            display: none;
        }

        .upload-progress {
            margin-top: 1rem;
            display: none;
        }

        .upload-progress.visible {
            display: block;
        }

        .progress-bar {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.3s;
        }

        /* Status Bar */
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-top: 1px solid var(--border);
            padding: 0.75rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 50;
        }

        .status-info {
            display: flex;
            gap: 2rem;
        }

        .status-item {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .status-item strong {
            color: var(--text);
        }

        /* Build Output */
        .build-output {
            background: #1e1e1e;
            color: #d4d4d4;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8rem;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 1rem;
        }

        .build-output:empty::before {
            content: 'No build output yet...';
            opacity: 0.5;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 5rem;
            right: 1.5rem;
            z-index: 200;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .toast {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            animation: slideIn 0.3s ease;
            box-shadow: var(--shadow);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.info { background: var(--primary); }

        /* Spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-light);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 450px;
            transform: scale(0.9);
            transition: transform 0.2s;
        }

        .modal-overlay.visible .modal {
            transform: scale(1);
        }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 1.1rem;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--text);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-body .form-group {
            margin-bottom: 1rem;
        }

        .modal-body .form-group:last-child {
            margin-bottom: 0;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* Project List Actions */
        .project-list-actions {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 0.5rem;
        }

        .btn-sm {
            padding: 0.4rem 0.75rem;
            font-size: 0.8rem;
        }

        .btn-outline-danger {
            background: transparent;
            border: 1px solid var(--danger);
            color: var(--danger);
        }

        .btn-outline-danger:hover:not(:disabled) {
            background: var(--danger);
            color: white;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .main-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
            }

            .metadata-grid {
                grid-template-columns: 1fr;
            }
        }

        .has-changes {
            border-color: var(--warning) !important;
        }

        .save-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--warning);
        }
    </style>
</head>
<body>
    <!-- Auth Overlay -->
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-card">
            <h2>Portfolio Manager</h2>
            <p>Enter admin password to continue</p>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Enter password" autocomplete="current-password">
            </div>
            <button class="auth-btn" onclick="authenticate()">Login</button>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <h1>Portfolio Manager</h1>
            <div class="header-actions">
                <button class="btn btn-outline" onclick="previewSite()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                    Preview
                </button>
                <button class="btn btn-success" id="saveBuildBtn" onclick="saveAndBuild()" disabled>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                        <polyline points="17,21 17,13 7,13 7,21"/>
                        <polyline points="7,3 7,8 15,8"/>
                    </svg>
                    Save & Build
                </button>
                <button class="btn btn-publish" id="publishBtn" onclick="publishSite()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"/>
                        <polyline points="16,6 12,2 8,6"/>
                        <line x1="12" y1="2" x2="12" y2="15"/>
                    </svg>
                    Publish
                </button>
                <button class="btn btn-outline" onclick="logout()">Logout</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-resizer" id="sidebarResizer"></div>
            <div class="project-list">
                <div class="project-list-header">
                    <span>Projects</span>
                    <span id="projectCount">0</span>
                </div>
                <div class="project-list-actions">
                    <button class="btn btn-sm btn-primary" onclick="showNewProjectModal()" style="flex:1">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        New
                    </button>
                    <button class="btn btn-sm btn-outline-danger" id="deleteProjectBtn" onclick="deleteCurrentProject()" disabled style="flex:1">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"/><path d="M19 6l-2 14H7L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4h6v2"/>
                        </svg>
                        Delete
                    </button>
                </div>
                <div id="projectList"></div>
            </div>

            <!-- Template Selector Panel -->
            <div class="template-panel">
                <div class="template-header">
                    <span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>
                        </svg>
                        Color Theme
                    </span>
                    <span id="currentTheme">default</span>
                </div>
                <div class="template-grid" id="templateGrid">
                    <!-- Templates will be rendered by JS -->
                </div>
            </div>

            <!-- Layout Selector Panel -->
            <div class="template-panel" style="margin-top: 1rem;">
                <div class="template-header" style="background: linear-gradient(135deg, #06b6d420, #06b6d405);">
                    <span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
                            <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
                        </svg>
                        Site Layout
                    </span>
                    <span id="currentLayout">modern</span>
                </div>
                <div class="template-grid" id="layoutGrid">
                    <!-- Layouts will be rendered by JS -->
                </div>
            </div>


            <!-- Site Content Editor Button -->
            <div class="template-panel" style="margin-top: 1rem;">
                <div class="template-header" style="background: linear-gradient(135deg, #10b98120, #10b98105);">
                    <span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                        Site Content
                    </span>
                </div>
                <div style="padding: 0.75rem;">
                    <button class="btn btn-success" style="width: 100%;" onclick="showContentEditor()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                        Edit All Content
                    </button>
                    <p style="font-size: 0.7rem; color: var(--text-light); margin-top: 0.5rem; text-align: center;">
                        Edit hero, timeline, about, contact
                    </p>
                </div>
            </div>
        </aside>

        <!-- Content Area -->
        <main class="content-area">
            <!-- No Selection State -->
            <div id="emptyState" class="panel">
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <polyline points="21,15 16,10 5,21"/>
                    </svg>
                    <h3>Select a Project</h3>
                    <p>Choose a project from the sidebar to edit its metadata and organize images.</p>
                </div>
            </div>

            <!-- Project Editor -->
            <div id="projectEditor" style="display: none;">
                <!-- Metadata Panel -->
                <div class="panel">
                    <div class="panel-header">
                        <h3>Project Metadata</h3>
                        <span class="save-indicator" id="changeIndicator" style="display: none;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <circle cx="12" cy="12" r="6"/>
                            </svg>
                            Unsaved changes
                        </span>
                    </div>
                    <div class="panel-body">
                        <div class="metadata-grid">
                            <div class="form-group">
                                <label for="projectTitle">Title</label>
                                <input type="text" id="projectTitle" placeholder="Project title">
                            </div>
                            <div class="form-group">
                                <label for="projectYear">Year</label>
                                <input type="text" id="projectYear" placeholder="e.g., 2024">
                            </div>
                            <div class="form-group">
                                <label for="projectTags">Tags</label>
                                <input type="text" id="projectTags" placeholder="Tag1 • Tag2 • Tag3">
                            </div>
                            <div class="form-group">
                                <label for="projectCategory">Category</label>
                                <select id="projectCategory">
                                    <option value="makers">Maker Projects</option>
                                    <option value="art">Art & Creative</option>
                                    <option value="education">School & Learning</option>
                                    <option value="community">Community & Service</option>
                                </select>
                            </div>
                            <div class="form-group full-width">
                                <label for="projectDescription">Description</label>
                                <textarea id="projectDescription" rows="3" placeholder="Project description..."></textarea>
                            </div>
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="projectFeatured">
                                    <label for="projectFeatured">Featured on homepage</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gallery Panel -->
                <div class="panel">
                    <div class="panel-header">
                        <h3>Gallery Images</h3>
                        <span id="imageCount">0 images</span>
                    </div>
                    <div class="panel-body">
                        <!-- Upload Drop Zone -->
                        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            <h4>Drop images here</h4>
                            <p>or click to browse (JPG, PNG, GIF, WebP, HEIC)</p>
                            <input type="file" id="fileInput" multiple accept="image/jpeg,image/png,image/gif,image/webp,image/heic,image/heif,.heic,.heif">
                            <div class="upload-progress" id="uploadProgress">
                                <div class="progress-bar">
                                    <div class="progress-bar-fill" id="progressFill" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <p style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 1rem;">
                            Drag and drop to reorder images. Order will be saved when you click "Save All".
                        </p>
                        <div class="gallery-grid" id="galleryGrid"></div>
                    </div>
                </div>

                <!-- Build Status Panel -->
                <div class="panel">
                    <div class="panel-header">
                        <h3>Build Status</h3>
                        <span id="buildStatus">Ready</span>
                    </div>
                    <div class="panel-body">
                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                            <div class="status-item">
                                <strong>Last Build:</strong> <span id="lastBuildTime">Never</span>
                            </div>
                            <div class="status-item">
                                <strong>Result:</strong> <span id="lastBuildResult">No builds yet</span>
                            </div>
                        </div>
                        <div class="build-output" id="buildOutput"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- New Project Modal -->
    <div class="modal-overlay" id="newProjectModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Create New Project</h3>
                <button class="modal-close" onclick="closeNewProjectModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="newProjectTitle">Project Title *</label>
                    <input type="text" id="newProjectTitle" placeholder="e.g., My New Project">
                </div>
                <div class="form-group">
                    <label for="newProjectSlug">Folder Name (slug) *</label>
                    <input type="text" id="newProjectSlug" placeholder="e.g., my-new-project">
                    <small style="color: var(--text-light); font-size: 0.75rem;">
                        Letters, numbers, and hyphens only. Will be created in images/ folder.
                    </small>
                </div>
                <div class="form-group">
                    <label for="newProjectCategory">Category</label>
                    <select id="newProjectCategory">
                        <option value="makers">Maker Projects</option>
                        <option value="art">Art & Creative</option>
                        <option value="education">School & Learning</option>
                        <option value="community">Community & Service</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="newProjectYear">Year</label>
                    <input type="text" id="newProjectYear" placeholder="2024" value="2024">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeNewProjectModal()">Cancel</button>
                <button class="btn btn-success" onclick="createNewProject()">Create Project</button>
            </div>
        </div>
    </div>

    <!-- Bulk Upload Modal -->
    <div class="modal-overlay" id="bulkUploadModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3>Create New Project</h3>
                <button class="modal-close" onclick="closeBulkUploadModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Project Details -->
                <div class="form-group">
                    <label for="bulkProjectTitle">Project Title *</label>
                    <input type="text" id="bulkProjectTitle" placeholder="e.g., My New Project" oninput="autoGenerateSlug()">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="bulkProjectSlug">Folder Name (slug) *</label>
                        <input type="text" id="bulkProjectSlug" placeholder="e.g., my-new-project">
                        <small style="color: var(--text-light); font-size: 0.75rem;">Letters, numbers, hyphens only</small>
                    </div>
                    <div class="form-group">
                        <label for="bulkParentFolder">Parent Folder</label>
                        <select id="bulkParentFolder">
                            <option value="">None (root images/)</option>
                            <!-- Will be populated dynamically -->
                        </select>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="bulkProjectYear">Year</label>
                        <input type="text" id="bulkProjectYear" placeholder="e.g., 2025">
                    </div>
                    <div class="form-group">
                        <label for="bulkProjectCategory">Category</label>
                        <select id="bulkProjectCategory">
                            <option value="makers">Maker Projects</option>
                            <option value="art">Art & Creative</option>
                            <option value="education">School & Learning</option>
                            <option value="community">Community & Service</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="bulkProjectTags">Tags</label>
                    <input type="text" id="bulkProjectTags" placeholder="e.g., Woodworking - Furniture - Design">
                </div>

                <div class="form-group">
                    <label for="bulkProjectDescription">Description</label>
                    <textarea id="bulkProjectDescription" rows="2" placeholder="Brief description of the project..."></textarea>
                </div>

                <!-- File Upload Area -->
                <div class="form-group">
                    <label>Upload Images</label>
                    <div id="bulkDropZone" class="drop-zone" onclick="document.getElementById('bulkFileInput').click()">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--text-light)" stroke-width="1.5">
                            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        <p style="margin: 1rem 0 0.5rem; font-weight: 600;">Drop images or folder here</p>
                        <p style="color: var(--text-light); font-size: 0.85rem;">or click to browse</p>
                        <p style="color: var(--text-light); font-size: 0.75rem; margin-top: 0.5rem;">Supports: JPG, PNG, GIF, WebP, HEIC</p>
                    </div>
                    <input type="file" id="bulkFileInput" multiple accept="image/*,.heic,.heif" style="display: none;" onchange="handleBulkFileSelect(event)" webkitdirectory>
                    <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
                        <button type="button" class="btn" style="flex: 1; background: var(--border);" onclick="document.getElementById('bulkFileInputFiles').click()">
                            Select Files
                        </button>
                        <button type="button" class="btn" style="flex: 1; background: var(--border);" onclick="document.getElementById('bulkFileInput').click()">
                            Select Folder
                        </button>
                    </div>
                    <input type="file" id="bulkFileInputFiles" multiple accept="image/*,.heic,.heif" style="display: none;" onchange="handleBulkFileSelect(event)">
                </div>

                <!-- Selected Files Preview -->
                <div id="bulkFilesPreview" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <label style="margin: 0;">Selected Files (<span id="bulkFileCount">0</span>)</label>
                        <button type="button" class="btn" style="padding: 0.3rem 0.6rem; font-size: 0.75rem; background: var(--danger); color: white;" onclick="clearBulkFiles()">Clear All</button>
                    </div>
                    <div id="bulkFilesList" style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 0.5rem;"></div>
                </div>

                <!-- Progress Bar -->
                <div id="bulkUploadProgress" style="display: none; margin-top: 1rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span id="bulkProgressText">Uploading...</span>
                        <span id="bulkProgressPercent">0%</span>
                    </div>
                    <div style="background: var(--border); border-radius: 4px; height: 8px; overflow: hidden;">
                        <div id="bulkProgressBar" style="background: var(--primary); height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeBulkUploadModal()">Cancel</button>
                <button class="btn btn-success" id="bulkUploadBtn" onclick="startBulkUpload()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    Upload & Create Project
                </button>
            </div>
        </div>
    </div>

    <!-- Content Editor Modal -->
    <div class="modal-overlay" id="contentEditorModal">
        <div class="modal" style="max-width: 900px; max-height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h3>Edit Site Content</h3>
                <button class="modal-close" onclick="closeContentEditor()">&times;</button>
            </div>

            <!-- Tabs -->
            <div class="content-tabs">
                <button class="content-tab active" data-tab="site" onclick="switchContentTab('site')">Site Info</button>
                <button class="content-tab" data-tab="hero" onclick="switchContentTab('hero')">Hero</button>
                <button class="content-tab" data-tab="featured" onclick="switchContentTab('featured')">Featured</button>
                <button class="content-tab" data-tab="timeline" onclick="switchContentTab('timeline')">Timeline</button>
                <button class="content-tab" data-tab="about" onclick="switchContentTab('about')">About</button>
                <button class="content-tab" data-tab="contact" onclick="switchContentTab('contact')">Contact</button>
                <button class="content-tab" data-tab="projects" onclick="switchContentTab('projects')">Projects</button>
            </div>

            <div class="modal-body" style="flex: 1; overflow-y: auto;">
                <!-- Site Info Tab -->
                <div class="content-tab-panel active" id="tab-site">
                    <div class="form-group">
                        <label for="siteName">Site Name</label>
                        <input type="text" id="siteName" placeholder="Reyan Makes">
                    </div>
                    <div class="form-group">
                        <label for="siteTitle">Page Title (browser tab)</label>
                        <input type="text" id="siteTitle" placeholder="Reyan Makes - Builder, Designer, Maker">
                    </div>
                    <div class="form-group">
                        <label for="siteDescription">Meta Description (SEO)</label>
                        <textarea id="siteDescription" rows="2" placeholder="Short description for search engines..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="footerCopyright">Footer Copyright</label>
                        <input type="text" id="footerCopyright" placeholder="© 2025 Your Name | Built with passion">
                    </div>
                </div>

                <!-- Hero Tab -->
                <div class="content-tab-panel" id="tab-hero">
                    <div class="form-group">
                        <label for="heroTitle">Title</label>
                        <input type="text" id="heroTitle" placeholder="Hi, I'm Reyan">
                    </div>
                    <div class="form-group">
                        <label for="heroSubtitle">Subtitle</label>
                        <input type="text" id="heroSubtitle" placeholder="High School Maker • Builder • Creator">
                    </div>
                    <div class="form-group">
                        <label for="heroDescription">Description</label>
                        <textarea id="heroDescription" rows="3" placeholder="A brief intro about yourself..."></textarea>
                    </div>
                    <div class="metadata-grid">
                        <div class="form-group">
                            <label for="heroCtaText">CTA Button Text</label>
                            <input type="text" id="heroCtaText" placeholder="Explore My Work">
                        </div>
                        <div class="form-group">
                            <label for="heroCtaLink">CTA Button Link</label>
                            <input type="text" id="heroCtaLink" placeholder="#featured">
                        </div>
                    </div>
                    <h4 style="margin-top: 1.5rem; margin-bottom: 1rem; font-size: 0.9rem; color: var(--text-light);">Social Links</h4>
                    <div class="metadata-grid">
                        <div class="form-group">
                            <label for="youtubeUrl">YouTube URL</label>
                            <input type="text" id="youtubeUrl" placeholder="https://youtube.com/@channel">
                        </div>
                        <div class="form-group">
                            <label for="youtubeLabel">YouTube Label</label>
                            <input type="text" id="youtubeLabel" placeholder="@reyanmakes">
                        </div>
                    </div>
                </div>

                <!-- Featured Tab -->
                <div class="content-tab-panel" id="tab-featured">
                    <div class="form-group">
                        <label for="featuredTitle">Section Title</label>
                        <input type="text" id="featuredTitle" placeholder="Featured Builds">
                    </div>
                    <div class="form-group">
                        <label for="featuredSubtitle">Section Subtitle</label>
                        <input type="text" id="featuredSubtitle" placeholder="My best work showcasing...">
                    </div>
                    <p style="font-size: 0.85rem; color: var(--text-light); margin-top: 1rem;">
                        Manage featured projects using the "Featured Order" panel in the sidebar.
                    </p>
                </div>

                <!-- Timeline Tab -->
                <div class="content-tab-panel" id="tab-timeline">
                    <div class="form-group">
                        <label for="timelineTitle">Section Title</label>
                        <input type="text" id="timelineTitle" placeholder="My Maker Journey">
                    </div>
                    <div class="form-group">
                        <label for="timelineSubtitle">Section Subtitle</label>
                        <input type="text" id="timelineSubtitle" placeholder="From beginnings to now...">
                    </div>

                    <h4 style="margin-top: 1.5rem; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                        <span>Milestones</span>
                        <button class="btn btn-sm btn-primary" onclick="addMilestone()">+ Add Milestone</button>
                    </h4>
                    <div id="milestonesContainer">
                        <!-- Milestones will be rendered here -->
                    </div>
                </div>

                <!-- About Tab -->
                <div class="content-tab-panel" id="tab-about">
                    <div class="form-group">
                        <label for="aboutTitle">Section Title</label>
                        <input type="text" id="aboutTitle" placeholder="About Me">
                    </div>
                    <div class="form-group">
                        <label>About Paragraphs</label>
                        <div id="aboutParagraphsContainer">
                            <!-- Paragraphs will be rendered here -->
                        </div>
                        <button class="btn btn-sm btn-outline" onclick="addAboutParagraph()" style="margin-top: 0.5rem;">+ Add Paragraph</button>
                    </div>
                    <div class="form-group">
                        <label for="skillsTitle">Skills Title</label>
                        <input type="text" id="skillsTitle" placeholder="Skills & Experience">
                    </div>
                    <div class="form-group">
                        <label for="skillsList">Skills (one per line)</label>
                        <textarea id="skillsList" rows="6" placeholder="Woodworking&#10;Welding&#10;Design..."></textarea>
                    </div>
                </div>

                <!-- Contact Tab -->
                <div class="content-tab-panel" id="tab-contact">
                    <div class="form-group">
                        <label for="contactTitle">Section Title</label>
                        <input type="text" id="contactTitle" placeholder="Let's Connect">
                    </div>
                    <div class="form-group">
                        <label for="contactDescription">Description</label>
                        <textarea id="contactDescription" rows="2" placeholder="Want to collaborate..."></textarea>
                    </div>

                    <h4 style="margin-top: 1.5rem; margin-bottom: 1rem;">Contact Links</h4>
                    <div id="contactLinksContainer">
                        <!-- Contact links will be rendered here -->
                    </div>
                    <button class="btn btn-sm btn-outline" onclick="addContactLink()" style="margin-top: 0.5rem;">+ Add Link</button>
                </div>

                <!-- Projects Tab -->
                <div class="content-tab-panel" id="tab-projects">
                    <p style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 1rem;">
                        Edit project metadata (title, description, tags, year, category). Select a project to edit:
                    </p>
                    <div class="form-group">
                        <label for="projectEditSelect">Select Project</label>
                        <select id="projectEditSelect" onchange="loadProjectForEditing()">
                            <option value="">Choose a project...</option>
                        </select>
                    </div>

                    <div id="projectEditForm" style="display: none;">
                        <hr style="margin: 1.5rem 0; border-color: var(--border);">
                        <div class="form-group">
                            <label for="editProjectTitle">Title</label>
                            <input type="text" id="editProjectTitle">
                        </div>
                        <div class="metadata-grid">
                            <div class="form-group">
                                <label for="editProjectYear">Year</label>
                                <input type="text" id="editProjectYear">
                            </div>
                            <div class="form-group">
                                <label for="editProjectCategory">Category</label>
                                <select id="editProjectCategory">
                                    <option value="makers">Maker Projects</option>
                                    <option value="art">Art & Creative</option>
                                    <option value="education">School & Learning</option>
                                    <option value="community">Community & Service</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="editProjectTags">Tags</label>
                            <input type="text" id="editProjectTags" placeholder="Tag1 • Tag2 • Tag3">
                        </div>
                        <div class="form-group">
                            <label for="editProjectDescription">Description</label>
                            <textarea id="editProjectDescription" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="editProjectFeatured" style="width: auto; margin-right: 0.5rem;">
                                Featured Project
                            </label>
                        </div>
                        <button class="btn btn-primary" onclick="saveProjectEdit()" style="margin-top: 1rem;">Update Project</button>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeContentEditor()">Cancel</button>
                <button class="btn btn-success" onclick="saveContentChanges()">Save Content</button>
            </div>
        </div>
    </div>

    <style>
        /* Content Editor Tabs */
        /* Drop Zone Styles */
        .drop-zone {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg);
        }

        .drop-zone:hover,
        .drop-zone.drag-over {
            border-color: var(--primary);
            background: rgba(102, 126, 234, 0.05);
        }

        .drop-zone.drag-over {
            transform: scale(1.01);
        }

        .bulk-file-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem;
            background: var(--bg);
            border-radius: 4px;
            margin-bottom: 0.25rem;
            font-size: 0.85rem;
        }

        .bulk-file-item svg {
            flex-shrink: 0;
            color: var(--success);
        }

        .bulk-file-item .file-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .bulk-file-item .file-size {
            color: var(--text-light);
            font-size: 0.75rem;
        }

        .content-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            padding: 0 1rem;
            gap: 0.25rem;
            overflow-x: auto;
        }

        .content-tab {
            padding: 0.75rem 1rem;
            border: none;
            background: none;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-light);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .content-tab:hover {
            color: var(--text);
        }

        .content-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .content-tab-panel {
            display: none;
        }

        .content-tab-panel.active {
            display: block;
        }

        /* Milestone Card */
        .milestone-card-edit {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .milestone-card-edit .milestone-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .milestone-card-edit .milestone-header h5 {
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .milestone-card-edit .milestone-header .drag-handle {
            cursor: grab;
            color: var(--text-light);
        }

        .milestone-card-edit .delete-milestone {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            padding: 0.25rem;
        }

        .milestone-card-edit .form-group {
            margin-bottom: 0.75rem;
        }

        .milestone-card-edit .form-group:last-child {
            margin-bottom: 0;
        }

        .milestone-card-edit label {
            font-size: 0.75rem;
        }

        .milestone-card-edit input,
        .milestone-card-edit textarea {
            font-size: 0.85rem;
            padding: 0.5rem 0.75rem;
        }

        /* Paragraph edit */
        .paragraph-edit {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .paragraph-edit textarea {
            flex: 1;
        }

        .paragraph-edit .delete-para {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            padding: 0.25rem;
        }

        /* Contact link edit */
        .contact-link-edit {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            align-items: center;
        }

        .contact-link-edit input {
            flex: 1;
        }

        .contact-link-edit .delete-link {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            padding: 0.25rem;
        }

        /* Milestone links */
        .milestone-links-edit {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .milestone-link-chip {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.5rem 0.25rem 0.75rem;
            border-radius: 16px;
            font-size: 0.75rem;
        }

        .milestone-link-chip button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0;
            opacity: 0.7;
        }

        .milestone-link-chip button:hover {
            opacity: 1;
        }
    </style>

    <script>
        // State
        let password = '';
        let siteIndex = null;
        let metadata = null;
        let currentProject = null;
        let hasChanges = false;
        let imageOrder = {}; // Track custom image order per project
        let hiddenImages = {}; // Track hidden images per project
        let currentTemplate = 'default';
        let currentLayout = 'modern';

        // Template configurations with preview colors
        const templateConfigs = {
            default: { name: 'Default', colors: ['#667eea', '#764ba2', '#ffffff'] },
            dark: { name: 'Dark', colors: ['#a78bfa', '#f472b6', '#1a1a2e'] },
            ocean: { name: 'Ocean', colors: ['#14b8a6', '#06b6d4', '#f0fdfa'] },
            forest: { name: 'Forest', colors: ['#22c55e', '#84cc16', '#f7fdf7'] },
            sunset: { name: 'Sunset', colors: ['#f97316', '#ef4444', '#fffbf5'] }
        };

        // Layout configurations with preview wireframes
        const layoutConfigs = {
            default: { name: 'Default', desc: 'Standard card grid layout', icon: '▣ ▣ ▣' },
            pinterest: { name: 'Pinterest', desc: 'Masonry grid, hover effects', icon: '▦ ▤ ▥' },
            instagram: { name: 'Instagram', desc: 'Square grid, minimal text', icon: '□ □ □' },
            portfolio: { name: 'Portfolio', desc: 'Bold agency, dramatic typography', icon: '▓▓▓' }
        };

        // Auth
        const savedPassword = sessionStorage.getItem('adminPassword');
        if (savedPassword) {
            password = savedPassword;
            hideAuth();
            init();
        }

        document.getElementById('password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') authenticate();
        });

        function authenticate() {
            const pwd = document.getElementById('password').value;
            if (!pwd) {
                showToast('Please enter a password', 'error');
                return;
            }
            password = pwd;
            sessionStorage.setItem('adminPassword', password);
            hideAuth();
            init();
        }

        function hideAuth() {
            document.getElementById('authOverlay').classList.add('hidden');
        }

        function logout() {
            password = '';
            sessionStorage.removeItem('adminPassword');
            location.reload();
        }

        // Initialize
        async function init() {
            try {
                // Load site index
                const indexRes = await fetch('/gen/site-index.json');
                siteIndex = await indexRes.json();

                // Load metadata
                const metaRes = await fetch('/projects-metadata.json');
                metadata = await metaRes.json();

                // Load current template and layout from metadata
                currentTemplate = metadata.siteSettings?.template || 'default';
                currentLayout = metadata.siteSettings?.layout || 'default';

                // Load saved image orders if any
                const savedOrders = localStorage.getItem('imageOrders');
                if (savedOrders) {
                    imageOrder = JSON.parse(savedOrders);
                }

                // Load hidden images from server
                try {
                    const hiddenRes = await fetch('/api/hidden-images');
                    hiddenImages = await hiddenRes.json();
                } catch (e) {
                    console.log('No hidden images data');
                    hiddenImages = {};
                }

                renderProjectList();
                renderFeaturedOrder();
                renderTemplateSelector();
                renderLayoutSelector();
                startStatusPolling();
                showToast('Portfolio loaded successfully', 'success');
            } catch (error) {
                console.error('Failed to load data:', error);
                showToast('Failed to load portfolio data', 'error');
            }
        }

        function renderProjectList() {
            const list = document.getElementById('projectList');

            // Merge projects from siteIndex and metadata
            const allProjects = {};
            for (const [slug, proj] of Object.entries(siteIndex.projects || {})) {
                allProjects[slug] = proj;
            }
            for (const [slug, meta] of Object.entries(metadata.projects || {})) {
                if (!allProjects[slug]) {
                    allProjects[slug] = {
                        title: meta.title,
                        year: meta.year || '2024',
                        images: 0,
                        path: slug
                    };
                }
            }

            // Get featured order
            const featuredOrder = metadata.featuredOrder || [];
            const featuredProjects = featuredOrder
                .filter(slug => allProjects[slug])
                .map(slug => [slug, allProjects[slug]]);

            const otherProjects = Object.entries(allProjects)
                .filter(([slug]) => !featuredOrder.includes(slug))
                .sort((a, b) => a[1].title.localeCompare(b[1].title));

            document.getElementById('projectCount').textContent = Object.keys(allProjects).length;

            const renderItem = ([slug, project], isFeatured, index) => {
                const isEmpty = project.images === 0;
                return `
                    <div class="project-item ${currentProject === slug ? 'active' : ''} ${isEmpty ? 'empty-project' : ''} ${isFeatured ? 'featured-item' : ''}"
                         data-slug="${slug}" draggable="true" onclick="selectProject('${slug}')">
                        <span class="drag-handle" title="Drag to reorder">⋮⋮</span>
                        <div class="project-info">
                            <h4>${isFeatured ? `${index + 1}. ` : ''}${project.title}</h4>
                            <span>${isEmpty ? 'No images' : `${project.images} imgs`} • ${project.year}</span>
                        </div>
                        ${isEmpty ? '<span class="empty-badge">Empty</span>' : ''}
                    </div>
                `;
            };

            let html = '';

            // Featured section
            html += `<div class="section-divider featured">Featured (${featuredProjects.length})</div>`;
            html += `<div id="featuredSection">`;
            if (featuredProjects.length === 0) {
                html += '<div class="drop-zone" style="padding: 1rem; text-align: center; color: var(--text-light); font-size: 0.8rem;">Drag projects here to feature</div>';
            } else {
                html += featuredProjects.map((p, i) => renderItem(p, true, i)).join('');
            }
            html += '</div>';

            // Other projects section
            html += `<div id="otherSection">`;
            html += otherProjects.map(p => renderItem(p, false)).join('');
            html += '</div>';

            list.innerHTML = html;
            initProjectDragDrop();
        }

        function toggleFeatured(slug) {
            if (!metadata.featuredOrder) metadata.featuredOrder = [];

            const index = metadata.featuredOrder.indexOf(slug);
            if (index > -1) {
                metadata.featuredOrder.splice(index, 1);
                if (metadata.projects[slug]) {
                    metadata.projects[slug].featured = false;
                }
            } else {
                metadata.featuredOrder.push(slug);
                if (!metadata.projects[slug]) metadata.projects[slug] = {};
                metadata.projects[slug].featured = true;
            }

            markChanged();
            renderProjectList();
        }

        function initProjectDragDrop() {
            const featuredSection = document.getElementById('featuredSection');
            const otherSection = document.getElementById('otherSection');
            const projectList = document.getElementById('projectList');

            if (!featuredSection || !otherSection) return;

            let draggedSlug = null;

            // Make sections droppable
            [featuredSection, otherSection].forEach(section => {
                section.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    section.style.background = 'rgba(102, 126, 234, 0.1)';
                });

                section.addEventListener('dragleave', () => {
                    section.style.background = '';
                });

                section.addEventListener('drop', (e) => {
                    e.preventDefault();
                    section.style.background = '';

                    if (!draggedSlug) return;

                    const isFeaturedSection = section.id === 'featuredSection';
                    let changed = false;

                    if (isFeaturedSection) {
                        // Get current DOM order (reflects drag position)
                        const newOrder = [...featuredSection.querySelectorAll('.project-item')].map(el => el.dataset.slug);

                        if (!metadata.featuredOrder.includes(draggedSlug)) {
                            // Adding new item to featured
                            metadata.featuredOrder = newOrder;
                            if (!metadata.projects[draggedSlug]) metadata.projects[draggedSlug] = {};
                            metadata.projects[draggedSlug].featured = true;
                            changed = true;
                        } else if (JSON.stringify(newOrder) !== JSON.stringify(metadata.featuredOrder)) {
                            // Reordering within featured
                            metadata.featuredOrder = newOrder;
                            changed = true;
                        }
                    } else {
                        // Remove from featured
                        const idx = metadata.featuredOrder.indexOf(draggedSlug);
                        if (idx > -1) {
                            metadata.featuredOrder.splice(idx, 1);
                            if (metadata.projects[draggedSlug]) {
                                metadata.projects[draggedSlug].featured = false;
                            }
                            changed = true;
                        }
                    }

                    if (changed) {
                        markChanged();
                        renderProjectList();
                    }
                });
            });

            // Make items draggable
            projectList.querySelectorAll('.project-item[draggable="true"]').forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedSlug = item.dataset.slug;
                    item.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', draggedSlug);
                });

                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');

                    // Always check for order changes on dragend
                    const newOrder = [...featuredSection.querySelectorAll('.project-item')].map(el => el.dataset.slug);
                    const wasInFeatured = metadata.featuredOrder.includes(draggedSlug);
                    const isNowInFeatured = newOrder.includes(draggedSlug);

                    let changed = false;

                    if (wasInFeatured !== isNowInFeatured) {
                        // Moved between sections
                        if (isNowInFeatured) {
                            if (!metadata.projects[draggedSlug]) metadata.projects[draggedSlug] = {};
                            metadata.projects[draggedSlug].featured = true;
                        } else {
                            if (metadata.projects[draggedSlug]) {
                                metadata.projects[draggedSlug].featured = false;
                            }
                        }
                        metadata.featuredOrder = newOrder;
                        changed = true;
                    } else if (JSON.stringify(newOrder) !== JSON.stringify(metadata.featuredOrder)) {
                        // Reordered within featured section
                        metadata.featuredOrder = newOrder;
                        changed = true;
                    }

                    if (changed) {
                        markChanged();
                        renderProjectList();
                    }

                    draggedSlug = null;
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const dragging = projectList.querySelector('.dragging');
                    if (dragging && dragging !== item && item.parentElement === dragging.parentElement) {
                        const rect = item.getBoundingClientRect();
                        const midY = rect.top + rect.height / 2;
                        if (e.clientY < midY) {
                            item.parentElement.insertBefore(dragging, item);
                        } else {
                            item.parentElement.insertBefore(dragging, item.nextSibling);
                        }
                    }
                });

                // Handle drop on items (for reordering within section)
                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.stopPropagation();

                    if (!draggedSlug) return;

                    // Get current DOM order of featured items
                    const newOrder = [...featuredSection.querySelectorAll('.project-item')].map(el => el.dataset.slug);

                    // Check if item moved between sections
                    const wasInFeatured = metadata.featuredOrder.includes(draggedSlug);
                    const isNowInFeatured = newOrder.includes(draggedSlug);

                    if (wasInFeatured !== isNowInFeatured) {
                        // Moved between sections
                        if (isNowInFeatured) {
                            if (!metadata.projects[draggedSlug]) metadata.projects[draggedSlug] = {};
                            metadata.projects[draggedSlug].featured = true;
                        } else {
                            if (metadata.projects[draggedSlug]) {
                                metadata.projects[draggedSlug].featured = false;
                            }
                        }
                        metadata.featuredOrder = newOrder;
                        markChanged();
                        renderProjectList();
                    } else if (isNowInFeatured && JSON.stringify(newOrder) !== JSON.stringify(metadata.featuredOrder)) {
                        // Reordered within featured section
                        metadata.featuredOrder = newOrder;
                        markChanged();
                        renderProjectList();
                    }
                });
            });
        }

        // Featured Order Functions (deprecated - now merged into project list)
        function renderFeaturedOrder() {
            // Now handled by renderProjectList - kept for compatibility
        }

        function renderTemplateSelector() {
            const grid = document.getElementById('templateGrid');
            const themeLabel = document.getElementById('currentTheme');

            themeLabel.textContent = templateConfigs[currentTemplate]?.name || 'Default';

            grid.innerHTML = Object.entries(templateConfigs).map(([key, config]) => {
                const isActive = key === currentTemplate;
                const [primary, secondary, bg] = config.colors;
                return `
                    <div class="template-card ${isActive ? 'active' : ''}" onclick="selectTemplate('${key}')">
                        <div class="template-preview">
                            <div class="color-bar" style="background: ${primary}"></div>
                            <div class="color-bar" style="background: ${secondary}"></div>
                            <div class="color-bar" style="background: ${bg}; border: 1px solid #e2e8f0;"></div>
                        </div>
                        <div class="template-name">${config.name}</div>
                    </div>
                `;
            }).join('');
        }

        async function selectTemplate(templateKey) {
            if (templateKey === currentTemplate) return;

            try {
                const res = await fetch('/api/template', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Password': password
                    },
                    body: JSON.stringify({ template: templateKey })
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.error || 'Failed to save template');
                }

                currentTemplate = templateKey;
                metadata.siteSettings = metadata.siteSettings || {};
                metadata.siteSettings.template = templateKey;
                renderTemplateSelector();
                showToast(`Theme changed to ${templateConfigs[templateKey].name}. Refresh page to see changes.`, 'success');

                // No build needed - config-loader.js dynamically loads theme CSS
            } catch (error) {
                console.error('Failed to save template:', error);
                showToast(error.message, 'error');
            }
        }

        function renderLayoutSelector() {
            const grid = document.getElementById('layoutGrid');
            const layoutLabel = document.getElementById('currentLayout');

            layoutLabel.textContent = layoutConfigs[currentLayout]?.name || 'Default';

            grid.innerHTML = Object.entries(layoutConfigs).map(([key, config]) => {
                const isActive = key === currentLayout;
                return `
                    <div class="template-card ${isActive ? 'active' : ''}" onclick="selectLayout('${key}')" style="padding: 0.75rem;">
                        <div style="font-size: 1.2rem; letter-spacing: 2px; margin-bottom: 0.4rem; color: var(--primary);">${config.icon}</div>
                        <div class="template-name">${config.name}</div>
                        <div style="font-size: 0.65rem; opacity: 0.7; margin-top: 0.2rem;">${config.desc}</div>
                    </div>
                `;
            }).join('');
        }

        async function selectLayout(layoutKey) {
            if (layoutKey === currentLayout) return;

            try {
                const res = await fetch('/api/layout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Password': password
                    },
                    body: JSON.stringify({ layout: layoutKey })
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.error || 'Failed to save layout');
                }

                currentLayout = layoutKey;
                metadata.siteSettings = metadata.siteSettings || {};
                metadata.siteSettings.layout = layoutKey;
                renderLayoutSelector();
                showToast(`Layout changed to ${layoutConfigs[layoutKey].name}. Refresh page to see changes.`, 'success');

                // No build needed - config-loader.js dynamically loads layout CSS
                // All layouts now show all projects (same HTML content)
            } catch (error) {
                console.error('Failed to save layout:', error);
                showToast(error.message, 'error');
            }
        }

        function initFeaturedDragDrop() {
            const items = document.querySelectorAll('.featured-order-item');
            let draggedItem = null;

            items.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedItem = item;
                    item.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });

                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                    draggedItem = null;
                    updateFeaturedOrderNumbers();
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';

                    if (draggedItem && draggedItem !== item) {
                        const list = document.getElementById('featuredOrderList');
                        const allItems = [...list.querySelectorAll('.featured-order-item')];
                        const draggedIdx = allItems.indexOf(draggedItem);
                        const targetIdx = allItems.indexOf(item);

                        if (draggedIdx < targetIdx) {
                            item.parentNode.insertBefore(draggedItem, item.nextSibling);
                        } else {
                            item.parentNode.insertBefore(draggedItem, item);
                        }
                    }
                });

                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    saveFeaturedOrder();
                });
            });
        }

        function updateFeaturedOrderNumbers() {
            const items = document.querySelectorAll('.featured-order-item');
            items.forEach((item, idx) => {
                const numEl = item.querySelector('.order-num');
                if (numEl) numEl.textContent = idx + 1;
            });
        }

        function saveFeaturedOrder() {
            const items = document.querySelectorAll('.featured-order-item');
            const newOrder = [...items].map(item => item.dataset.slug);

            metadata.featuredOrder = newOrder;

            // Update featured flag in each project
            Object.keys(metadata.projects).forEach(slug => {
                metadata.projects[slug].featured = newOrder.includes(slug);
            });

            document.getElementById('featuredCount').textContent = newOrder.length;
            hasChanges = true;
            updateChangeIndicator();
            renderProjectList(); // Update badges in project list
        }

        function addToFeatured(slug) {
            if (!slug) return;

            if (!metadata.featuredOrder) {
                metadata.featuredOrder = [];
            }

            if (!metadata.featuredOrder.includes(slug)) {
                metadata.featuredOrder.push(slug);

                // Mark as featured in project metadata
                if (!metadata.projects[slug]) {
                    metadata.projects[slug] = {};
                }
                metadata.projects[slug].featured = true;

                hasChanges = true;
                updateChangeIndicator();
                renderFeaturedOrder();
                renderProjectList();
                showToast('Added to featured!', 'success');
            }

            // Reset dropdown
            document.getElementById('addFeaturedSelect').value = '';
        }

        function removeFromFeatured(slug) {
            if (!metadata.featuredOrder) return;

            metadata.featuredOrder = metadata.featuredOrder.filter(s => s !== slug);

            // Remove featured flag
            if (metadata.projects[slug]) {
                metadata.projects[slug].featured = false;
            }

            hasChanges = true;
            updateChangeIndicator();
            renderFeaturedOrder();
            renderProjectList();
            showToast('Removed from featured', 'info');
        }

        async function selectProject(slug) {
            if (hasChanges) {
                if (!confirm('You have unsaved changes. Discard them?')) {
                    return;
                }
            }

            currentProject = slug;
            hasChanges = false;
            updateChangeIndicator();

            // Get project from siteIndex or create stub for empty projects
            const project = siteIndex.projects[slug] || {
                title: metadata.projects[slug]?.title || slug,
                year: metadata.projects[slug]?.year || '2024',
                path: slug,
                images: 0
            };
            const meta = metadata.projects[slug] || metadata.defaults;

            // Update UI
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('projectEditor').style.display = 'block';
            document.getElementById('deleteProjectBtn').disabled = false;

            // Fill metadata form
            document.getElementById('projectTitle').value = meta.title || project.title;
            document.getElementById('projectYear').value = meta.year || project.year;
            document.getElementById('projectTags').value = meta.tags || '';
            document.getElementById('projectCategory').value = meta.category || 'makers';
            document.getElementById('projectDescription').value = meta.description || '';
            document.getElementById('projectFeatured').checked = meta.featured || false;

            // Load gallery images
            await loadGalleryImages(slug);

            // Initialize upload zone
            initUploadZone();

            // Update project list to show active
            renderProjectList();

            // Add change listeners
            ['projectTitle', 'projectYear', 'projectTags', 'projectCategory', 'projectDescription', 'projectFeatured'].forEach(id => {
                const el = document.getElementById(id);
                el.onchange = el.oninput = markChanged;
            });
        }

        async function loadGalleryImages(slug) {
            const project = siteIndex.projects[slug];
            const grid = document.getElementById('galleryGrid');

            // Handle empty projects (not in siteIndex)
            if (!project || !project.manifest) {
                grid.innerHTML = '<p class="empty-gallery-message">No images yet. Upload images using the form above.</p>';
                document.getElementById('imageCount').textContent = '0 images';
                return;
            }

            const manifestPath = project.manifest;

            try {
                const res = await fetch(manifestPath);
                const manifest = await res.json();

                let images = manifest.images.slice(); // Copy manifest images (visible)

                // Add hidden images back for admin display
                const projectHidden = hiddenImages[slug] || [];
                projectHidden.forEach(img => {
                    if (!images.includes(img)) {
                        images.push(img);
                    }
                });

                // Apply custom order if exists
                if (imageOrder[slug]) {
                    const order = imageOrder[slug];
                    images = images.sort((a, b) => {
                        const aIdx = order.indexOf(a);
                        const bIdx = order.indexOf(b);
                        if (aIdx === -1) return 1;
                        if (bIdx === -1) return -1;
                        return aIdx - bIdx;
                    });
                }

                const thumbPath = `gen/thumbnails/${project.path}`;
                const imagePath = `images/${project.path}`;

                grid.innerHTML = images.map((img, idx) => {
                    const thumbName = img.replace(/\.(jpg|jpeg|png|JPG|JPEG|PNG)$/i, '.jpg');
                    const isHidden = projectHidden.includes(img);
                    const hiddenClass = isHidden ? ' hidden-image' : '';
                    const hideIcon = isHidden
                        ? '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>'  // eye icon (show)
                        : '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/>'; // eye-off icon (hide)
                    const hideTitle = isHidden ? 'Show image' : 'Hide image';
                    return `
                        <div class="gallery-item${hiddenClass}" draggable="true" data-image="${img}">
                            <span class="gallery-item-index">${idx + 1}</span>
                            <button class="gallery-item-hide" onclick="toggleImageVisibility('${img}')" title="${hideTitle}">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    ${hideIcon}
                                </svg>
                            </button>
                            <button class="gallery-item-delete" onclick="deleteImage('${img}')" title="Delete image">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                            </button>
                            <img src="${thumbPath}/${thumbName}"
                                 onerror="this.src='${imagePath}/${img}'"
                                 alt="${img}">
                            <div class="gallery-item-overlay">${img}</div>
                        </div>
                    `;
                }).join('');

                const visibleCount = images.length - projectHidden.length;
                const hiddenCount = projectHidden.length;
                const countText = hiddenCount > 0
                    ? `${visibleCount} visible, ${hiddenCount} hidden`
                    : `${images.length} images`;
                document.getElementById('imageCount').textContent = countText;

                // Initialize drag and drop
                initDragDrop();

            } catch (error) {
                console.error('Failed to load gallery:', error);
                grid.innerHTML = '<p class="empty-gallery-message">No images yet. Upload images using the form above.</p>';
                document.getElementById('imageCount').textContent = '0 images';
            }
        }

        function initDragDrop() {
            const items = document.querySelectorAll('.gallery-item');
            let draggedItem = null;

            items.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedItem = item;
                    item.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });

                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                    document.querySelectorAll('.gallery-item').forEach(i => i.classList.remove('drag-over'));
                    updateImageOrder();
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    if (item !== draggedItem) {
                        item.classList.add('drag-over');
                    }
                });

                item.addEventListener('dragleave', () => {
                    item.classList.remove('drag-over');
                });

                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (item !== draggedItem) {
                        const grid = document.getElementById('galleryGrid');
                        const allItems = [...grid.querySelectorAll('.gallery-item')];
                        const draggedIdx = allItems.indexOf(draggedItem);
                        const dropIdx = allItems.indexOf(item);

                        if (draggedIdx < dropIdx) {
                            item.after(draggedItem);
                        } else {
                            item.before(draggedItem);
                        }

                        // Update index numbers
                        grid.querySelectorAll('.gallery-item').forEach((item, idx) => {
                            item.querySelector('.gallery-item-index').textContent = idx + 1;
                        });

                        markChanged();
                    }
                });
            });
        }

        function updateImageOrder() {
            const grid = document.getElementById('galleryGrid');
            const items = grid.querySelectorAll('.gallery-item');
            const order = [...items].map(item => item.dataset.image);
            imageOrder[currentProject] = order;
        }

        function markChanged() {
            hasChanges = true;
            updateChangeIndicator();
        }

        function updateChangeIndicator() {
            document.getElementById('changeIndicator').style.display = hasChanges ? 'inline-flex' : 'none';
            document.getElementById('saveBuildBtn').disabled = !hasChanges;
        }

        async function saveChanges() {
            // Update current project metadata if one is selected
            if (currentProject) {
                if (!metadata.projects[currentProject]) {
                    metadata.projects[currentProject] = {};
                }

                const meta = metadata.projects[currentProject];
                meta.title = document.getElementById('projectTitle').value;
                meta.year = document.getElementById('projectYear').value;
                meta.tags = document.getElementById('projectTags').value;
                meta.category = document.getElementById('projectCategory').value;
                meta.description = document.getElementById('projectDescription').value;
                meta.featured = document.getElementById('projectFeatured').checked;
            }

            try {
                // Save metadata via API (includes featuredOrder and all project data)
                const res = await fetch('/api/metadata', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password, metadata })
                });

                if (!res.ok) {
                    throw new Error('Failed to save metadata');
                }

                // Save image order locally
                localStorage.setItem('imageOrders', JSON.stringify(imageOrder));

                // Also save image order via API if we have a custom order for the current project
                if (currentProject && imageOrder[currentProject]) {
                    await fetch('/api/image-order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            password,
                            project: currentProject,
                            order: imageOrder[currentProject]
                        })
                    });
                }

                hasChanges = false;
                updateChangeIndicator();
                renderProjectList();
                showToast('Changes saved successfully!', 'success');

            } catch (error) {
                console.error('Failed to save:', error);
                showToast('Failed to save changes', 'error');
            }
        }

        async function saveAndBuild() {
            const btn = document.getElementById('saveBuildBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Saving...';

            try {
                // First save changes
                await saveChanges();

                // Then trigger build
                btn.innerHTML = '<span class="spinner"></span> Building...';

                const res = await fetch('/api/build', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || 'Build failed');
                }

                showToast('Saved & build started!', 'success');

            } catch (error) {
                showToast(error.message, 'error');
                btn.disabled = false;
                btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17,21 17,13 7,13 7,21"/><polyline points="7,3 7,8 15,8"/></svg> Save & Build';
            }
        }

        async function publishSite() {
            const btn = document.getElementById('publishBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Publishing...';

            try {
                const res = await fetch('/api/publish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                const text = await res.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    throw new Error('Server error - please restart the server');
                }

                if (!res.ok) {
                    throw new Error(data.error || 'Publish failed');
                }

                showToast(data.message || 'Published successfully!', 'success');
                btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"/><polyline points="16,6 12,2 8,6"/><line x1="12" y1="2" x2="12" y2="15"/></svg> Publish';
                btn.disabled = false;

            } catch (error) {
                showToast(error.message, 'error');
                btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"/><polyline points="16,6 12,2 8,6"/><line x1="12" y1="2" x2="12" y2="15"/></svg> Publish';
                btn.disabled = false;
            }
        }

        function startStatusPolling() {
            setInterval(async () => {
                try {
                    const res = await fetch('/api/build/status');
                    const status = await res.json();

                    const saveBuildBtn = document.getElementById('saveBuildBtn');
                    const statusEl = document.getElementById('buildStatus');
                    const outputEl = document.getElementById('buildOutput');
                    const lastTimeEl = document.getElementById('lastBuildTime');
                    const lastResultEl = document.getElementById('lastBuildResult');

                    if (status.running) {
                        saveBuildBtn.disabled = true;
                        saveBuildBtn.innerHTML = '<span class="spinner"></span> Building...';
                        statusEl.textContent = 'Building...';
                        statusEl.style.color = 'var(--warning)';
                    } else {
                        saveBuildBtn.disabled = !hasChanges;
                        saveBuildBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17,21 17,13 7,13 7,21"/><polyline points="7,3 7,8 15,8"/></svg> Save & Build';
                        statusEl.textContent = 'Ready';
                        statusEl.style.color = 'var(--success)';
                    }

                    if (status.last_run) {
                        lastTimeEl.textContent = new Date(status.last_run * 1000).toLocaleString();
                    }

                    if (status.last_result) {
                        lastResultEl.textContent = status.last_result.success ? 'Success' : 'Failed';
                        lastResultEl.style.color = status.last_result.success ? 'var(--success)' : 'var(--danger)';
                    }

                    if (status.output) {
                        outputEl.textContent = status.output;
                        outputEl.scrollTop = outputEl.scrollHeight;
                    }

                } catch (error) {
                    console.error('Status poll failed:', error);
                }
            }, 2000);
        }

        function previewSite() {
            window.open('/', '_blank');
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Upload functionality
        function initUploadZone() {
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');

            // Drag and drop events
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('drag-over');
            });

            uploadZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('drag-over');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('drag-over');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    uploadFiles(files);
                }
            });

            // File input change
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    uploadFiles(e.target.files);
                }
            });
        }

        async function uploadFiles(files) {
            if (!currentProject) {
                showToast('Please select a project first', 'error');
                return;
            }

            // Get project from siteIndex or create stub for empty projects (same logic as selectProject)
            const project = siteIndex.projects[currentProject] || {
                title: metadata.projects[currentProject]?.title || currentProject,
                year: metadata.projects[currentProject]?.year || '2024',
                path: currentProject,  // Use slug as path for new/empty projects
                images: 0
            };

            const uploadZone = document.getElementById('uploadZone');
            const uploadProgress = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('progressFill');

            uploadZone.classList.add('uploading');
            uploadProgress.classList.add('visible');
            progressFill.style.width = '0%';

            const formData = new FormData();
            formData.append('password', password);
            formData.append('project_path', project.path);

            for (const file of files) {
                formData.append('images', file);
            }

            try {
                progressFill.style.width = '50%';

                const res = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                progressFill.style.width = '100%';

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || 'Upload failed');
                }

                if (data.uploaded.length > 0) {
                    showToast(`Uploaded ${data.uploaded.length} image(s)!`, 'success');
                    // Reload the gallery after a short delay
                    setTimeout(() => loadGalleryImages(currentProject), 500);
                }

                if (data.errors.length > 0) {
                    showToast(`${data.errors.length} file(s) failed: ${data.errors[0]}`, 'error');
                }

            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                uploadZone.classList.remove('uploading');
                setTimeout(() => {
                    uploadProgress.classList.remove('visible');
                    progressFill.style.width = '0%';
                }, 1000);
                // Clear file input
                document.getElementById('fileInput').value = '';
            }
        }

        // Project Management Functions
        function showNewProjectModal() {
            document.getElementById('newProjectModal').classList.add('visible');
            document.getElementById('newProjectTitle').value = '';
            document.getElementById('newProjectSlug').value = '';
            document.getElementById('newProjectYear').value = new Date().getFullYear();
            document.getElementById('newProjectTitle').focus();
        }

        function closeNewProjectModal() {
            document.getElementById('newProjectModal').classList.remove('visible');
        }

        // Auto-generate slug from title
        document.addEventListener('DOMContentLoaded', () => {
            const titleInput = document.getElementById('newProjectTitle');
            const slugInput = document.getElementById('newProjectSlug');
            if (titleInput && slugInput) {
                titleInput.addEventListener('input', () => {
                    slugInput.value = titleInput.value
                        .toLowerCase()
                        .replace(/[^a-z0-9]+/g, '-')
                        .replace(/^-|-$/g, '');
                });
            }

            // Sidebar resizer
            const sidebar = document.getElementById('sidebar');
            const resizer = document.getElementById('sidebarResizer');
            let isResizing = false;

            // Restore saved width
            const savedWidth = localStorage.getItem('sidebarWidth');
            if (savedWidth) {
                sidebar.style.width = savedWidth + 'px';
                updateCollapsedState(parseInt(savedWidth));
            }

            function updateCollapsedState(width) {
                if (width < 120) {
                    sidebar.classList.add('collapsed');
                } else {
                    sidebar.classList.remove('collapsed');
                }
            }

            resizer.addEventListener('mousedown', (e) => {
                isResizing = true;
                resizer.classList.add('dragging');
                document.body.style.cursor = 'ew-resize';
                document.body.style.userSelect = 'none';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                const sidebarRect = sidebar.getBoundingClientRect();
                let newWidth = e.clientX - sidebarRect.left;
                newWidth = Math.max(60, Math.min(500, newWidth));
                sidebar.style.width = newWidth + 'px';
                updateCollapsedState(newWidth);
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    resizer.classList.remove('dragging');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                    localStorage.setItem('sidebarWidth', parseInt(sidebar.style.width));
                }
            });
        });

        async function createNewProject() {
            const title = document.getElementById('newProjectTitle').value.trim();
            const slug = document.getElementById('newProjectSlug').value.trim();
            const category = document.getElementById('newProjectCategory').value;
            const year = document.getElementById('newProjectYear').value.trim();

            if (!title) {
                showToast('Please enter a project title', 'error');
                return;
            }

            if (!slug) {
                showToast('Please enter a folder name', 'error');
                return;
            }

            // Validate slug format
            if (!/^[a-z0-9-]+$/.test(slug)) {
                showToast('Folder name can only contain lowercase letters, numbers, and hyphens', 'error');
                return;
            }

            try {
                const res = await fetch('/api/create-project', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        password,
                        title,
                        slug,
                        category,
                        year
                    })
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || 'Failed to create project');
                }

                closeNewProjectModal();
                showToast('Project created! Run Build to update site.', 'success');

                // Reload data
                const metaRes = await fetch('/projects-metadata.json');
                metadata = await metaRes.json();
                renderProjectList();
                renderFeaturedOrder();

            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function deleteCurrentProject() {
            if (!currentProject) {
                showToast('No project selected', 'error');
                return;
            }

            const project = siteIndex.projects[currentProject];
            const title = metadata.projects[currentProject]?.title || project?.title || currentProject;

            if (!confirm(`Delete "${title}"?\n\nThis will permanently delete:\n- All images in this project\n- All thumbnails\n- The project page\n\nThis cannot be undone!`)) {
                return;
            }

            // Double confirm for safety
            if (!confirm('Are you REALLY sure? Type "delete" in the next prompt to confirm.')) {
                return;
            }

            const confirmText = prompt('Type "delete" to confirm:');
            if (confirmText !== 'delete') {
                showToast('Deletion cancelled', 'info');
                return;
            }

            try {
                const res = await fetch('/api/delete-project', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        password,
                        slug: currentProject
                    })
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || 'Failed to delete project');
                }

                showToast('Project deleted!', 'success');

                // Clear selection
                currentProject = null;
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('projectEditor').style.display = 'none';
                document.getElementById('deleteProjectBtn').disabled = true;

                // Reload data
                const indexRes = await fetch('/gen/site-index.json');
                siteIndex = await indexRes.json();
                const metaRes = await fetch('/projects-metadata.json');
                metadata = await metaRes.json();
                renderProjectList();
                renderFeaturedOrder();

            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function deleteImage(imageName) {
            if (!currentProject) {
                showToast('No project selected', 'error');
                return;
            }

            // Confirm deletion
            if (!confirm(`Delete "${imageName}"?\n\nThis will permanently remove the image and its thumbnail.`)) {
                return;
            }

            // Get project from siteIndex or create stub for empty projects
            const project = siteIndex.projects[currentProject] || {
                path: currentProject,
                images: 0
            };

            try {
                const res = await fetch('/api/delete-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        password,
                        project_path: project.path,
                        image_name: imageName
                    })
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || 'Delete failed');
                }

                showToast('Image deleted!', 'success');

                // Remove from image order if present
                if (imageOrder[currentProject]) {
                    imageOrder[currentProject] = imageOrder[currentProject].filter(img => img !== imageName);
                }

                // Reload the gallery
                await loadGalleryImages(currentProject);

            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function toggleImageVisibility(imageName) {
            if (!currentProject) {
                showToast('Select a project first', 'error');
                return;
            }

            // Determine current visibility state
            const projectHidden = hiddenImages[currentProject] || [];
            const isCurrentlyHidden = projectHidden.includes(imageName);
            const newHiddenState = !isCurrentlyHidden;

            try {
                const res = await fetch('/api/toggle-image-visibility', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        password,
                        project: currentProject,
                        image: imageName,
                        hide: newHiddenState
                    })
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || 'Toggle failed');
                }

                // Update local hidden images state
                if (newHiddenState) {
                    if (!hiddenImages[currentProject]) {
                        hiddenImages[currentProject] = [];
                    }
                    if (!hiddenImages[currentProject].includes(imageName)) {
                        hiddenImages[currentProject].push(imageName);
                    }
                } else {
                    if (hiddenImages[currentProject]) {
                        hiddenImages[currentProject] = hiddenImages[currentProject].filter(img => img !== imageName);
                        if (hiddenImages[currentProject].length === 0) {
                            delete hiddenImages[currentProject];
                        }
                    }
                }

                showToast(newHiddenState ? 'Image hidden' : 'Image visible', 'success');

                // Reload the gallery to show updated state
                await loadGalleryImages(currentProject);

            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        // ===============================
        // Bulk Upload Functions
        // ===============================

        let bulkSelectedFiles = [];

        async function showBulkUploadModal() {
            // Reset form
            document.getElementById('bulkProjectTitle').value = '';
            document.getElementById('bulkProjectSlug').value = '';
            document.getElementById('bulkProjectYear').value = new Date().getFullYear();
            document.getElementById('bulkProjectTags').value = '';
            document.getElementById('bulkProjectDescription').value = '';
            document.getElementById('bulkProjectCategory').value = 'makers';
            bulkSelectedFiles = [];
            updateBulkFilesPreview();

            // Hide progress
            document.getElementById('bulkUploadProgress').style.display = 'none';

            // Load parent folders
            await loadParentFolders();

            // Show modal
            document.getElementById('bulkUploadModal').classList.add('visible');

            // Setup drag and drop
            setupBulkDragDrop();
        }

        function closeBulkUploadModal() {
            document.getElementById('bulkUploadModal').classList.remove('visible');
            bulkSelectedFiles = [];
        }

        async function loadParentFolders() {
            try {
                const response = await fetch('/api/parent-folders');
                const data = await response.json();

                const select = document.getElementById('bulkParentFolder');
                select.innerHTML = '<option value="">None (root images/)</option>';

                if (data.folders) {
                    data.folders.forEach(folder => {
                        const option = document.createElement('option');
                        option.value = folder;
                        option.textContent = folder;
                        select.appendChild(option);
                    });
                }
            } catch (err) {
                console.error('Failed to load parent folders:', err);
            }
        }

        function autoGenerateSlug() {
            const title = document.getElementById('bulkProjectTitle').value;
            const slug = title
                .toLowerCase()
                .replace(/[^a-z0-9\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .trim();
            document.getElementById('bulkProjectSlug').value = slug;
        }

        function setupBulkDragDrop() {
            const dropZone = document.getElementById('bulkDropZone');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.add('drag-over');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.remove('drag-over');
                }, false);
            });

            dropZone.addEventListener('drop', handleBulkDrop, false);
        }

        async function handleBulkDrop(e) {
            const items = e.dataTransfer.items;
            const files = [];

            for (let i = 0; i < items.length; i++) {
                const item = items[i].webkitGetAsEntry();
                if (item) {
                    await traverseFileTree(item, files);
                }
            }

            addBulkFiles(files);
        }

        async function traverseFileTree(item, files) {
            return new Promise((resolve) => {
                if (item.isFile) {
                    item.file(file => {
                        if (isValidImageFile(file)) {
                            files.push(file);
                        }
                        resolve();
                    });
                } else if (item.isDirectory) {
                    const dirReader = item.createReader();
                    dirReader.readEntries(async entries => {
                        for (const entry of entries) {
                            await traverseFileTree(entry, files);
                        }
                        resolve();
                    });
                } else {
                    resolve();
                }
            });
        }

        function isValidImageFile(file) {
            const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/heic', 'image/heif'];
            const validExts = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.heic', '.heif'];
            const ext = '.' + file.name.split('.').pop().toLowerCase();
            return validTypes.includes(file.type) || validExts.includes(ext);
        }

        function handleBulkFileSelect(event) {
            const files = Array.from(event.target.files).filter(isValidImageFile);
            addBulkFiles(files);
            event.target.value = ''; // Reset input
        }

        function addBulkFiles(files) {
            // Add new files, avoid duplicates by name
            const existingNames = new Set(bulkSelectedFiles.map(f => f.name));
            files.forEach(file => {
                if (!existingNames.has(file.name)) {
                    bulkSelectedFiles.push(file);
                }
            });
            updateBulkFilesPreview();
        }

        function updateBulkFilesPreview() {
            const preview = document.getElementById('bulkFilesPreview');
            const list = document.getElementById('bulkFilesList');
            const count = document.getElementById('bulkFileCount');

            if (bulkSelectedFiles.length === 0) {
                preview.style.display = 'none';
                return;
            }

            preview.style.display = 'block';
            count.textContent = bulkSelectedFiles.length;

            list.innerHTML = bulkSelectedFiles.map((file, idx) => `
                <div class="bulk-file-item">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <polyline points="21,15 16,10 5,21"/>
                    </svg>
                    <span class="file-name">${escapeHtml(file.name)}</span>
                    <span class="file-size">${formatFileSize(file.size)}</span>
                    <button type="button" onclick="removeBulkFile(${idx})" style="background: none; border: none; cursor: pointer; color: var(--danger); padding: 0;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        function removeBulkFile(index) {
            bulkSelectedFiles.splice(index, 1);
            updateBulkFilesPreview();
        }

        function clearBulkFiles() {
            bulkSelectedFiles = [];
            updateBulkFilesPreview();
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        async function startBulkUpload() {
            const title = document.getElementById('bulkProjectTitle').value.trim();
            const slug = document.getElementById('bulkProjectSlug').value.trim();
            const year = document.getElementById('bulkProjectYear').value.trim() || new Date().getFullYear().toString();
            const tags = document.getElementById('bulkProjectTags').value.trim() || 'Project - Build - Maker';
            const description = document.getElementById('bulkProjectDescription').value.trim();
            const category = document.getElementById('bulkProjectCategory').value;
            const parentFolder = document.getElementById('bulkParentFolder').value;

            // Validation
            if (!title) {
                alert('Please enter a project title');
                return;
            }
            if (!slug) {
                alert('Please enter a folder name (slug)');
                return;
            }
            if (!/^[a-zA-Z0-9-]+$/.test(slug)) {
                alert('Folder name can only contain letters, numbers, and hyphens');
                return;
            }
            if (bulkSelectedFiles.length === 0) {
                alert('Please select at least one image to upload');
                return;
            }

            // Disable button
            const btn = document.getElementById('bulkUploadBtn');
            btn.disabled = true;
            btn.innerHTML = 'Uploading...';

            // Show progress
            const progressDiv = document.getElementById('bulkUploadProgress');
            const progressBar = document.getElementById('bulkProgressBar');
            const progressText = document.getElementById('bulkProgressText');
            const progressPercent = document.getElementById('bulkProgressPercent');
            progressDiv.style.display = 'block';

            // Prepare form data
            const formData = new FormData();
            formData.append('password', adminPassword);
            formData.append('title', title);
            formData.append('slug', slug);
            formData.append('year', year);
            formData.append('tags', tags.replace(/-/g, ' - '));
            formData.append('description', description);
            formData.append('category', category);
            formData.append('parent_folder', parentFolder);

            bulkSelectedFiles.forEach(file => {
                formData.append('images', file);
            });

            try {
                progressText.textContent = `Uploading ${bulkSelectedFiles.length} files...`;

                const response = await fetch('/api/bulk-upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Upload failed');
                }

                progressBar.style.width = '100%';
                progressPercent.textContent = '100%';
                progressText.textContent = `Uploaded ${result.uploaded.length} files`;

                if (result.errors && result.errors.length > 0) {
                    console.warn('Upload errors:', result.errors);
                }

                // Auto-rebuild site
                progressText.textContent = 'Building site...';
                await triggerBuildFromBulk();

                // Success
                alert(`Project "${title}" created successfully with ${result.uploaded.length} images!`);
                closeBulkUploadModal();

                // Reload metadata to show new project
                await loadMetadata();
                renderProjectList();

            } catch (err) {
                alert('Upload failed: ' + err.message);
                console.error('Bulk upload error:', err);
            } finally {
                btn.disabled = false;
                btn.innerHTML = `
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    Upload & Create Project
                `;
            }
        }

        async function triggerBuildFromBulk() {
            try {
                const response = await fetch('/api/build', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: adminPassword })
                });

                if (!response.ok) {
                    console.warn('Build trigger failed');
                    return;
                }

                // Wait for build to complete (poll status)
                let attempts = 0;
                while (attempts < 30) {
                    await new Promise(r => setTimeout(r, 1000));
                    const statusRes = await fetch('/api/build/status');
                    const status = await statusRes.json();
                    if (!status.running) {
                        break;
                    }
                    attempts++;
                }
            } catch (err) {
                console.error('Build error:', err);
            }
        }

        // ===============================
        // Content Editor Functions
        // ===============================

        let editingContent = null; // Temporary copy of siteContent being edited

        function showContentEditor() {
            // Create a deep copy of siteContent for editing
            editingContent = JSON.parse(JSON.stringify(metadata.siteContent || {}));

            // Populate all form fields
            populateContentForms();

            // Show modal
            document.getElementById('contentEditorModal').classList.add('visible');
        }

        function closeContentEditor() {
            document.getElementById('contentEditorModal').classList.remove('visible');
            editingContent = null;
        }

        function switchContentTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.content-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabName);
            });

            // Update tab panels
            document.querySelectorAll('.content-tab-panel').forEach(panel => {
                panel.classList.toggle('active', panel.id === `tab-${tabName}`);
            });
        }

        function populateContentForms() {
            const content = editingContent;

            // Site Info
            document.getElementById('siteName').value = content.siteName || '';
            document.getElementById('siteTitle').value = content.siteTitle || '';
            document.getElementById('siteDescription').value = content.siteDescription || '';
            document.getElementById('footerCopyright').value = content.footer?.copyright || '';

            // Hero
            const hero = content.hero || {};
            document.getElementById('heroTitle').value = hero.title || '';
            document.getElementById('heroSubtitle').value = hero.subtitle || '';
            document.getElementById('heroDescription').value = hero.description || '';
            document.getElementById('heroCtaText').value = hero.ctaText || '';
            document.getElementById('heroCtaLink').value = hero.ctaLink || '';
            document.getElementById('youtubeUrl').value = hero.social?.youtube?.url || '';
            document.getElementById('youtubeLabel').value = hero.social?.youtube?.label || '';

            // Featured
            const featured = content.featuredSection || {};
            document.getElementById('featuredTitle').value = featured.title || '';
            document.getElementById('featuredSubtitle').value = featured.subtitle || '';

            // Timeline
            const timeline = content.timeline || {};
            document.getElementById('timelineTitle').value = timeline.title || '';
            document.getElementById('timelineSubtitle').value = timeline.subtitle || '';
            renderMilestones(timeline.milestones || []);

            // About
            const about = content.about || {};
            document.getElementById('aboutTitle').value = about.title || '';
            document.getElementById('skillsTitle').value = about.skillsTitle || '';
            document.getElementById('skillsList').value = (about.skills || []).join('\n');
            renderAboutParagraphs(about.paragraphs || []);

            // Contact
            const contact = content.contact || {};
            document.getElementById('contactTitle').value = contact.title || '';
            document.getElementById('contactDescription').value = contact.description || '';
            renderContactLinks(contact.links || []);

            // Projects dropdown
            populateProjectEditDropdown();
        }

        function renderMilestones(milestones) {
            const container = document.getElementById('milestonesContainer');
            container.innerHTML = milestones.map((m, idx) => `
                <div class="milestone-card-edit" data-index="${idx}">
                    <div class="milestone-header">
                        <h5>
                            <span class="drag-handle">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                    <circle cx="9" cy="6" r="2"/><circle cx="15" cy="6" r="2"/>
                                    <circle cx="9" cy="12" r="2"/><circle cx="15" cy="12" r="2"/>
                                    <circle cx="9" cy="18" r="2"/><circle cx="15" cy="18" r="2"/>
                                </svg>
                            </span>
                            Milestone ${idx + 1}
                        </h5>
                        <button class="delete-milestone" onclick="deleteMilestone(${idx})" title="Delete milestone">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                    <div class="metadata-grid">
                        <div class="form-group">
                            <label>Year/Label</label>
                            <input type="text" value="${escapeHtml(m.year || '')}" onchange="updateMilestone(${idx}, 'year', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" value="${escapeHtml(m.title || '')}" onchange="updateMilestone(${idx}, 'title', this.value)">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea rows="2" onchange="updateMilestone(${idx}, 'description', this.value)">${escapeHtml(m.description || '')}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Focus Areas (comma separated)</label>
                        <input type="text" value="${(m.focusAreas || []).join(', ')}" onchange="updateMilestone(${idx}, 'focusAreas', this.value.split(',').map(s=>s.trim()).filter(s=>s))">
                    </div>
                    <div class="form-group">
                        <label>Project Links</label>
                        <div class="milestone-links-edit" id="milestone-links-${idx}">
                            ${(m.links || []).map((link, linkIdx) => `
                                <span class="milestone-link-chip">
                                    ${escapeHtml(link.label)}
                                    <button onclick="removeMilestoneLink(${idx}, ${linkIdx})">&times;</button>
                                </span>
                            `).join('')}
                        </div>
                        <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
                            <select id="milestone-link-select-${idx}" style="flex: 1; padding: 0.4rem; border-radius: 6px; border: 1px solid var(--border);">
                                <option value="">Select project...</option>
                                ${Object.entries(metadata.projects || {}).map(([slug, proj]) =>
                                    `<option value="${slug}">${proj.title || slug}</option>`
                                ).join('')}
                            </select>
                            <button class="btn btn-sm btn-primary" onclick="addMilestoneLink(${idx})">Add</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateMilestone(idx, field, value) {
            if (!editingContent.timeline) editingContent.timeline = { milestones: [] };
            if (!editingContent.timeline.milestones[idx]) return;
            editingContent.timeline.milestones[idx][field] = value;
        }

        function deleteMilestone(idx) {
            if (!confirm('Delete this milestone?')) return;
            editingContent.timeline.milestones.splice(idx, 1);
            renderMilestones(editingContent.timeline.milestones);
        }

        function addMilestone() {
            if (!editingContent.timeline) editingContent.timeline = { milestones: [] };
            editingContent.timeline.milestones.push({
                year: new Date().getFullYear().toString(),
                title: 'New Milestone',
                description: '',
                focusAreas: [],
                links: []
            });
            renderMilestones(editingContent.timeline.milestones);
        }

        function addMilestoneLink(milestoneIdx) {
            const select = document.getElementById(`milestone-link-select-${milestoneIdx}`);
            const projectSlug = select.value;
            if (!projectSlug) return;

            const projectTitle = metadata.projects[projectSlug]?.title || projectSlug;

            if (!editingContent.timeline.milestones[milestoneIdx].links) {
                editingContent.timeline.milestones[milestoneIdx].links = [];
            }

            // Check if already added
            if (editingContent.timeline.milestones[milestoneIdx].links.some(l => l.project === projectSlug)) {
                showToast('Project already added', 'info');
                return;
            }

            editingContent.timeline.milestones[milestoneIdx].links.push({
                label: projectTitle,
                project: projectSlug
            });

            renderMilestones(editingContent.timeline.milestones);
            showToast('Link added', 'success');
        }

        function removeMilestoneLink(milestoneIdx, linkIdx) {
            editingContent.timeline.milestones[milestoneIdx].links.splice(linkIdx, 1);
            renderMilestones(editingContent.timeline.milestones);
        }

        function renderAboutParagraphs(paragraphs) {
            const container = document.getElementById('aboutParagraphsContainer');
            container.innerHTML = paragraphs.map((p, idx) => `
                <div class="paragraph-edit">
                    <textarea rows="3" onchange="updateAboutParagraph(${idx}, this.value)">${escapeHtml(p)}</textarea>
                    <button class="delete-para" onclick="deleteAboutParagraph(${idx})" title="Delete paragraph">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        function updateAboutParagraph(idx, value) {
            if (!editingContent.about) editingContent.about = { paragraphs: [] };
            editingContent.about.paragraphs[idx] = value;
        }

        function deleteAboutParagraph(idx) {
            editingContent.about.paragraphs.splice(idx, 1);
            renderAboutParagraphs(editingContent.about.paragraphs);
        }

        function addAboutParagraph() {
            if (!editingContent.about) editingContent.about = { paragraphs: [] };
            editingContent.about.paragraphs.push('');
            renderAboutParagraphs(editingContent.about.paragraphs);
        }

        function renderContactLinks(links) {
            const container = document.getElementById('contactLinksContainer');
            container.innerHTML = links.map((link, idx) => `
                <div class="contact-link-edit">
                    <input type="text" placeholder="Label" value="${escapeHtml(link.label || '')}" onchange="updateContactLink(${idx}, 'label', this.value)">
                    <input type="text" placeholder="URL" value="${escapeHtml(link.url || '')}" onchange="updateContactLink(${idx}, 'url', this.value)">
                    <button class="delete-link" onclick="deleteContactLink(${idx})" title="Delete link">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        function updateContactLink(idx, field, value) {
            if (!editingContent.contact) editingContent.contact = { links: [] };
            editingContent.contact.links[idx][field] = value;
        }

        function deleteContactLink(idx) {
            editingContent.contact.links.splice(idx, 1);
            renderContactLinks(editingContent.contact.links);
        }

        function addContactLink() {
            if (!editingContent.contact) editingContent.contact = { links: [] };
            editingContent.contact.links.push({ label: '', url: '' });
            renderContactLinks(editingContent.contact.links);
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;')
                      .replace(/"/g, '&quot;')
                      .replace(/'/g, '&#39;');
        }

        async function saveContentChanges() {
            // Gather all form values
            editingContent.siteName = document.getElementById('siteName').value;
            editingContent.siteTitle = document.getElementById('siteTitle').value;
            editingContent.siteDescription = document.getElementById('siteDescription').value;

            // Footer
            if (!editingContent.footer) editingContent.footer = {};
            editingContent.footer.copyright = document.getElementById('footerCopyright').value;

            // Hero
            if (!editingContent.hero) editingContent.hero = {};
            editingContent.hero.title = document.getElementById('heroTitle').value;
            editingContent.hero.subtitle = document.getElementById('heroSubtitle').value;
            editingContent.hero.description = document.getElementById('heroDescription').value;
            editingContent.hero.ctaText = document.getElementById('heroCtaText').value;
            editingContent.hero.ctaLink = document.getElementById('heroCtaLink').value;

            // Social
            if (!editingContent.hero.social) editingContent.hero.social = {};
            if (!editingContent.hero.social.youtube) editingContent.hero.social.youtube = {};
            editingContent.hero.social.youtube.url = document.getElementById('youtubeUrl').value;
            editingContent.hero.social.youtube.label = document.getElementById('youtubeLabel').value;

            // Featured
            if (!editingContent.featuredSection) editingContent.featuredSection = {};
            editingContent.featuredSection.title = document.getElementById('featuredTitle').value;
            editingContent.featuredSection.subtitle = document.getElementById('featuredSubtitle').value;

            // Timeline titles
            if (!editingContent.timeline) editingContent.timeline = { milestones: [] };
            editingContent.timeline.title = document.getElementById('timelineTitle').value;
            editingContent.timeline.subtitle = document.getElementById('timelineSubtitle').value;

            // About
            if (!editingContent.about) editingContent.about = {};
            editingContent.about.title = document.getElementById('aboutTitle').value;
            editingContent.about.skillsTitle = document.getElementById('skillsTitle').value;
            editingContent.about.skills = document.getElementById('skillsList').value.split('\n').map(s => s.trim()).filter(s => s);

            // Contact
            if (!editingContent.contact) editingContent.contact = {};
            editingContent.contact.title = document.getElementById('contactTitle').value;
            editingContent.contact.description = document.getElementById('contactDescription').value;

            // Update metadata
            metadata.siteContent = editingContent;

            try {
                // Save via API
                const res = await fetch('/api/metadata', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password, metadata })
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.error || 'Failed to save content');
                }

                closeContentEditor();
                showToast('Content saved! Run Build to apply changes.', 'success');

            } catch (error) {
                console.error('Failed to save content:', error);
                showToast(error.message, 'error');
            }
        }

        // ===============================
        // Project Editor Functions
        // ===============================

        let editingProjectSlug = null;

        function populateProjectEditDropdown() {
            const select = document.getElementById('projectEditSelect');
            select.innerHTML = '<option value="">Choose a project...</option>';

            const projects = metadata.projects || {};
            Object.entries(projects).sort((a, b) => (a[1].title || a[0]).localeCompare(b[1].title || b[0])).forEach(([slug, proj]) => {
                const option = document.createElement('option');
                option.value = slug;
                option.textContent = proj.title || slug;
                select.appendChild(option);
            });

            // Reset form
            editingProjectSlug = null;
            document.getElementById('projectEditForm').style.display = 'none';
        }

        function loadProjectForEditing() {
            const select = document.getElementById('projectEditSelect');
            const slug = select.value;

            if (!slug) {
                document.getElementById('projectEditForm').style.display = 'none';
                editingProjectSlug = null;
                return;
            }

            const project = metadata.projects[slug];
            if (!project) return;

            editingProjectSlug = slug;

            // Populate form
            document.getElementById('editProjectTitle').value = project.title || '';
            document.getElementById('editProjectYear').value = project.year || '';
            document.getElementById('editProjectCategory').value = project.category || 'makers';
            document.getElementById('editProjectTags').value = project.tags || '';
            document.getElementById('editProjectDescription').value = project.description || '';
            document.getElementById('editProjectFeatured').checked = project.featured || false;

            // Show form
            document.getElementById('projectEditForm').style.display = 'block';
        }

        async function saveProjectEdit() {
            if (!editingProjectSlug) return;

            // Update metadata
            metadata.projects[editingProjectSlug] = {
                ...metadata.projects[editingProjectSlug],
                title: document.getElementById('editProjectTitle').value,
                year: document.getElementById('editProjectYear').value,
                category: document.getElementById('editProjectCategory').value,
                tags: document.getElementById('editProjectTags').value,
                description: document.getElementById('editProjectDescription').value,
                featured: document.getElementById('editProjectFeatured').checked
            };

            try {
                // Save via API
                const res = await fetch('/api/metadata', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password, metadata })
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.error || 'Failed to save project');
                }

                showToast(`Project "${metadata.projects[editingProjectSlug].title}" updated!`, 'success');

                // Refresh dropdown labels
                populateProjectEditDropdown();

            } catch (error) {
                console.error('Failed to save project:', error);
                showToast(error.message, 'error');
            }
        }
    </script>
</body>
</html>
