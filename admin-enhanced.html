<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Manager - Reyan Makes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #5a67d8;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        /* Buttons */
        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: white;
            color: var(--primary);
        }

        .btn-primary:hover:not(:disabled) {
            background: #f1f5f9;
            transform: translateY(-1px);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-outline {
            background: transparent;
            color: white;
            border: 2px solid rgba(255,255,255,0.5);
        }

        .btn-outline:hover {
            background: rgba(255,255,255,0.1);
        }

        /* Auth Section */
        .auth-overlay {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .auth-overlay.hidden {
            display: none;
        }

        .auth-card {
            background: white;
            padding: 2.5rem;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 400px;
        }

        .auth-card h2 {
            margin-bottom: 0.5rem;
            font-size: 1.5rem;
        }

        .auth-card p {
            color: var(--text-light);
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .auth-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        /* Main Layout */
        .main-content {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
            gap: 1.5rem;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            flex-shrink: 0;
        }

        .project-list {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .project-list-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .project-item {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .project-item:hover {
            background: #f8fafc;
        }

        .project-item.active {
            background: #eef2ff;
            border-left: 3px solid var(--primary);
        }

        .project-item:last-child {
            border-bottom: none;
        }

        .project-thumb {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            object-fit: cover;
            background: var(--border);
        }

        .project-info {
            flex: 1;
            min-width: 0;
        }

        .project-info h4 {
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .project-info span {
            font-size: 0.75rem;
            color: var(--text-light);
        }

        .featured-badge {
            background: var(--warning);
            color: white;
            font-size: 0.65rem;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-weight: 600;
        }

        .empty-badge {
            background: var(--text-muted);
            color: white;
            font-size: 0.65rem;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-weight: 600;
        }

        .empty-project {
            opacity: 0.7;
            border-left: 3px solid var(--text-muted);
        }

        .empty-gallery-message {
            grid-column: 1 / -1;
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
            font-style: italic;
        }

        /* Featured Order Panel */
        .featured-order-panel {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-top: 1rem;
            overflow: hidden;
        }

        .featured-order-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #f59e0b20, #f59e0b05);
        }

        .featured-order-header span:first-child {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .featured-order-list {
            padding: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .featured-order-item {
            padding: 0.75rem 1rem;
            margin: 0.25rem 0;
            border-radius: 8px;
            cursor: grab;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: #fef3c7;
            border: 1px solid #fcd34d;
        }

        .featured-order-item:hover {
            background: #fde68a;
        }

        .featured-order-item.dragging {
            opacity: 0.5;
            background: #fcd34d;
        }

        .featured-order-item .drag-handle {
            color: var(--text-light);
            cursor: grab;
        }

        .featured-order-item .order-num {
            background: var(--warning);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .featured-order-item .order-title {
            flex: 1;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .featured-order-item .remove-btn {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            opacity: 0.6;
        }

        .featured-order-item .remove-btn:hover {
            opacity: 1;
            background: #fecaca;
        }

        .featured-order-empty {
            padding: 2rem 1rem;
            text-align: center;
            color: var(--text-light);
            font-size: 0.85rem;
        }

        .add-featured-btn {
            margin: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--warning);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: calc(100% - 1rem);
        }

        .add-featured-btn:hover {
            background: #d97706;
        }

        /* Add to featured dropdown */
        .add-featured-dropdown {
            position: relative;
            margin: 0.5rem;
        }

        .add-featured-dropdown select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.85rem;
            background: white;
        }

        /* Template Selector Panel */
        .template-panel {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-top: 1rem;
            overflow: hidden;
        }

        .template-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #8b5cf620, #8b5cf605);
        }

        .template-header span:first-child {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .template-grid {
            padding: 0.75rem;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .template-card {
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid var(--border);
            background: white;
            text-align: center;
        }

        .template-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .template-card.active {
            border-color: var(--primary);
            background: #667eea10;
        }

        .template-preview {
            height: 32px;
            border-radius: 4px;
            margin-bottom: 0.4rem;
            display: flex;
            overflow: hidden;
        }

        .template-preview .color-bar {
            flex: 1;
        }

        .template-name {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text);
            text-transform: capitalize;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            min-width: 0;
        }

        .panel {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
        }

        .panel-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header h3 {
            font-size: 1.1rem;
        }

        .panel-body {
            padding: 1.5rem;
        }

        /* Metadata Editor */
        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .metadata-grid .full-width {
            grid-column: 1 / -1;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        /* Gallery Grid */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }

        .gallery-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
            background: var(--border);
        }

        .gallery-item:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }

        .gallery-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .gallery-item.drag-over {
            transform: scale(1.05);
            border: 2px dashed var(--primary);
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gallery-item-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 0.5rem;
            background: linear-gradient(transparent, rgba(0,0,0,0.7));
            color: white;
            font-size: 0.7rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .gallery-item:hover .gallery-item-overlay {
            opacity: 1;
        }

        .gallery-item-index {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            background: rgba(0,0,0,0.6);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .gallery-item-delete {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: var(--danger);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            z-index: 10;
        }

        .gallery-item:hover .gallery-item-delete {
            opacity: 1;
        }

        .gallery-item-delete:hover {
            transform: scale(1.1);
            background: #dc2626;
        }

        /* Upload Drop Zone */
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 1.5rem;
            transition: all 0.2s;
            cursor: pointer;
            background: var(--bg);
        }

        .upload-zone:hover {
            border-color: var(--primary);
            background: #f0f4ff;
        }

        .upload-zone.drag-over {
            border-color: var(--success);
            background: #ecfdf5;
            transform: scale(1.01);
        }

        .upload-zone.uploading {
            opacity: 0.7;
            pointer-events: none;
        }

        .upload-zone svg {
            width: 48px;
            height: 48px;
            color: var(--text-light);
            margin-bottom: 1rem;
        }

        .upload-zone h4 {
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .upload-zone p {
            font-size: 0.85rem;
            color: var(--text-light);
            margin: 0;
        }

        .upload-zone input[type="file"] {
            display: none;
        }

        .upload-progress {
            margin-top: 1rem;
            display: none;
        }

        .upload-progress.visible {
            display: block;
        }

        .progress-bar {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.3s;
        }

        /* Status Bar */
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-top: 1px solid var(--border);
            padding: 0.75rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 50;
        }

        .status-info {
            display: flex;
            gap: 2rem;
        }

        .status-item {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .status-item strong {
            color: var(--text);
        }

        /* Build Output */
        .build-output {
            background: #1e1e1e;
            color: #d4d4d4;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8rem;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 1rem;
        }

        .build-output:empty::before {
            content: 'No build output yet...';
            opacity: 0.5;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 5rem;
            right: 1.5rem;
            z-index: 200;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .toast {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            animation: slideIn 0.3s ease;
            box-shadow: var(--shadow);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.info { background: var(--primary); }

        /* Spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-light);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 450px;
            transform: scale(0.9);
            transition: transform 0.2s;
        }

        .modal-overlay.visible .modal {
            transform: scale(1);
        }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 1.1rem;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--text);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-body .form-group {
            margin-bottom: 1rem;
        }

        .modal-body .form-group:last-child {
            margin-bottom: 0;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* Project List Actions */
        .project-list-actions {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 0.5rem;
        }

        .btn-sm {
            padding: 0.4rem 0.75rem;
            font-size: 0.8rem;
        }

        .btn-outline-danger {
            background: transparent;
            border: 1px solid var(--danger);
            color: var(--danger);
        }

        .btn-outline-danger:hover:not(:disabled) {
            background: var(--danger);
            color: white;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .main-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
            }

            .metadata-grid {
                grid-template-columns: 1fr;
            }
        }

        .has-changes {
            border-color: var(--warning) !important;
        }

        .save-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--warning);
        }
    </style>
</head>
<body>
    <!-- Auth Overlay -->
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-card">
            <h2>Portfolio Manager</h2>
            <p>Enter admin password to continue</p>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Enter password" autocomplete="current-password">
            </div>
            <button class="auth-btn" onclick="authenticate()">Login</button>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <h1>Portfolio Manager</h1>
            <div class="header-actions">
                <button class="btn btn-outline" onclick="previewSite()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                    Preview
                </button>
                <button class="btn btn-primary" id="saveBtn" onclick="saveChanges()" disabled>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                        <polyline points="17,21 17,13 7,13 7,21"/>
                        <polyline points="7,3 7,8 15,8"/>
                    </svg>
                    Save All
                </button>
                <button class="btn btn-success" id="buildBtn" onclick="triggerBuild()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="16,3 21,3 21,8"/>
                        <line x1="4" y1="20" x2="21" y2="3"/>
                        <polyline points="21,16 21,21 16,21"/>
                        <line x1="15" y1="15" x2="21" y2="21"/>
                        <line x1="4" y1="4" x2="9" y2="9"/>
                    </svg>
                    Build Site
                </button>
                <button class="btn btn-outline" onclick="logout()">Logout</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="project-list">
                <div class="project-list-header">
                    <span>Projects</span>
                    <span id="projectCount">0</span>
                </div>
                <div class="project-list-actions">
                    <button class="btn btn-sm btn-primary" onclick="showNewProjectModal()" style="flex:1">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        New
                    </button>
                    <button class="btn btn-sm btn-outline-danger" id="deleteProjectBtn" onclick="deleteCurrentProject()" disabled style="flex:1">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"/><path d="M19 6l-2 14H7L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4h6v2"/>
                        </svg>
                        Delete
                    </button>
                </div>
                <div id="projectList"></div>
            </div>

            <!-- Featured Order Panel -->
            <div class="featured-order-panel">
                <div class="featured-order-header">
                    <span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                        </svg>
                        Featured Order
                    </span>
                    <span id="featuredCount">0</span>
                </div>
                <div class="featured-order-list" id="featuredOrderList">
                    <div class="featured-order-empty">No featured projects</div>
                </div>
                <div class="add-featured-dropdown">
                    <select id="addFeaturedSelect" onchange="addToFeatured(this.value)">
                        <option value="">+ Add to Featured...</option>
                    </select>
                </div>
            </div>

            <!-- Template Selector Panel -->
            <div class="template-panel">
                <div class="template-header">
                    <span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>
                        </svg>
                        Site Theme
                    </span>
                    <span id="currentTheme">default</span>
                </div>
                <div class="template-grid" id="templateGrid">
                    <!-- Templates will be rendered by JS -->
                </div>
            </div>
        </aside>

        <!-- Content Area -->
        <main class="content-area">
            <!-- No Selection State -->
            <div id="emptyState" class="panel">
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <polyline points="21,15 16,10 5,21"/>
                    </svg>
                    <h3>Select a Project</h3>
                    <p>Choose a project from the sidebar to edit its metadata and organize images.</p>
                </div>
            </div>

            <!-- Project Editor -->
            <div id="projectEditor" style="display: none;">
                <!-- Metadata Panel -->
                <div class="panel">
                    <div class="panel-header">
                        <h3>Project Metadata</h3>
                        <span class="save-indicator" id="changeIndicator" style="display: none;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <circle cx="12" cy="12" r="6"/>
                            </svg>
                            Unsaved changes
                        </span>
                    </div>
                    <div class="panel-body">
                        <div class="metadata-grid">
                            <div class="form-group">
                                <label for="projectTitle">Title</label>
                                <input type="text" id="projectTitle" placeholder="Project title">
                            </div>
                            <div class="form-group">
                                <label for="projectYear">Year</label>
                                <input type="text" id="projectYear" placeholder="e.g., 2024">
                            </div>
                            <div class="form-group">
                                <label for="projectTags">Tags</label>
                                <input type="text" id="projectTags" placeholder="Tag1 • Tag2 • Tag3">
                            </div>
                            <div class="form-group">
                                <label for="projectCategory">Category</label>
                                <select id="projectCategory">
                                    <option value="makers">Maker Projects</option>
                                    <option value="art">Art & Creative</option>
                                    <option value="education">School & Learning</option>
                                    <option value="community">Community & Service</option>
                                </select>
                            </div>
                            <div class="form-group full-width">
                                <label for="projectDescription">Description</label>
                                <textarea id="projectDescription" rows="3" placeholder="Project description..."></textarea>
                            </div>
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="projectFeatured">
                                    <label for="projectFeatured">Featured on homepage</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gallery Panel -->
                <div class="panel">
                    <div class="panel-header">
                        <h3>Gallery Images</h3>
                        <span id="imageCount">0 images</span>
                    </div>
                    <div class="panel-body">
                        <!-- Upload Drop Zone -->
                        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            <h4>Drop images here</h4>
                            <p>or click to browse (JPG, PNG, GIF, WebP, HEIC)</p>
                            <input type="file" id="fileInput" multiple accept="image/jpeg,image/png,image/gif,image/webp,image/heic,image/heif,.heic,.heif">
                            <div class="upload-progress" id="uploadProgress">
                                <div class="progress-bar">
                                    <div class="progress-bar-fill" id="progressFill" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <p style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 1rem;">
                            Drag and drop to reorder images. Order will be saved when you click "Save All".
                        </p>
                        <div class="gallery-grid" id="galleryGrid"></div>
                    </div>
                </div>

                <!-- Build Status Panel -->
                <div class="panel">
                    <div class="panel-header">
                        <h3>Build Status</h3>
                        <span id="buildStatus">Ready</span>
                    </div>
                    <div class="panel-body">
                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                            <div class="status-item">
                                <strong>Last Build:</strong> <span id="lastBuildTime">Never</span>
                            </div>
                            <div class="status-item">
                                <strong>Result:</strong> <span id="lastBuildResult">No builds yet</span>
                            </div>
                        </div>
                        <div class="build-output" id="buildOutput"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- New Project Modal -->
    <div class="modal-overlay" id="newProjectModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Create New Project</h3>
                <button class="modal-close" onclick="closeNewProjectModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="newProjectTitle">Project Title *</label>
                    <input type="text" id="newProjectTitle" placeholder="e.g., My New Project">
                </div>
                <div class="form-group">
                    <label for="newProjectSlug">Folder Name (slug) *</label>
                    <input type="text" id="newProjectSlug" placeholder="e.g., my-new-project">
                    <small style="color: var(--text-light); font-size: 0.75rem;">
                        Letters, numbers, and hyphens only. Will be created in images/ folder.
                    </small>
                </div>
                <div class="form-group">
                    <label for="newProjectCategory">Category</label>
                    <select id="newProjectCategory">
                        <option value="makers">Maker Projects</option>
                        <option value="art">Art & Creative</option>
                        <option value="education">School & Learning</option>
                        <option value="community">Community & Service</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="newProjectYear">Year</label>
                    <input type="text" id="newProjectYear" placeholder="2024" value="2024">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeNewProjectModal()">Cancel</button>
                <button class="btn btn-success" onclick="createNewProject()">Create Project</button>
            </div>
        </div>
    </div>

    <script>
        // State
        let password = '';
        let siteIndex = null;
        let metadata = null;
        let currentProject = null;
        let hasChanges = false;
        let imageOrder = {}; // Track custom image order per project
        let currentTemplate = 'default';

        // Template configurations with preview colors
        const templateConfigs = {
            default: { name: 'Default', colors: ['#667eea', '#764ba2', '#ffffff'] },
            dark: { name: 'Dark', colors: ['#a78bfa', '#f472b6', '#1a1a2e'] },
            ocean: { name: 'Ocean', colors: ['#14b8a6', '#06b6d4', '#f0fdfa'] },
            forest: { name: 'Forest', colors: ['#22c55e', '#84cc16', '#f7fdf7'] },
            sunset: { name: 'Sunset', colors: ['#f97316', '#ef4444', '#fffbf5'] }
        };

        // Auth
        const savedPassword = sessionStorage.getItem('adminPassword');
        if (savedPassword) {
            password = savedPassword;
            hideAuth();
            init();
        }

        document.getElementById('password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') authenticate();
        });

        function authenticate() {
            const pwd = document.getElementById('password').value;
            if (!pwd) {
                showToast('Please enter a password', 'error');
                return;
            }
            password = pwd;
            sessionStorage.setItem('adminPassword', password);
            hideAuth();
            init();
        }

        function hideAuth() {
            document.getElementById('authOverlay').classList.add('hidden');
        }

        function logout() {
            password = '';
            sessionStorage.removeItem('adminPassword');
            location.reload();
        }

        // Initialize
        async function init() {
            try {
                // Load site index
                const indexRes = await fetch('/gen/site-index.json');
                siteIndex = await indexRes.json();

                // Load metadata
                const metaRes = await fetch('/projects-metadata.json');
                metadata = await metaRes.json();

                // Load current template from metadata
                currentTemplate = metadata.siteSettings?.template || 'default';

                // Load saved image orders if any
                const savedOrders = localStorage.getItem('imageOrders');
                if (savedOrders) {
                    imageOrder = JSON.parse(savedOrders);
                }

                renderProjectList();
                renderFeaturedOrder();
                renderTemplateSelector();
                startStatusPolling();
                showToast('Portfolio loaded successfully', 'success');
            } catch (error) {
                console.error('Failed to load data:', error);
                showToast('Failed to load portfolio data', 'error');
            }
        }

        function renderProjectList() {
            const list = document.getElementById('projectList');

            // Merge projects from siteIndex and metadata (metadata may have empty projects)
            const allProjects = {};

            // Add projects from siteIndex (have images)
            for (const [slug, proj] of Object.entries(siteIndex.projects || {})) {
                allProjects[slug] = proj;
            }

            // Add projects from metadata that aren't in siteIndex (empty/new projects)
            for (const [slug, meta] of Object.entries(metadata.projects || {})) {
                if (!allProjects[slug]) {
                    allProjects[slug] = {
                        title: meta.title,
                        year: meta.year || '2024',
                        images: 0,
                        path: slug  // Simple path for new projects
                    };
                }
            }

            const projects = Object.entries(allProjects)
                .sort((a, b) => {
                    // Featured first, then by name
                    const aFeatured = metadata.projects[a[0]]?.featured || false;
                    const bFeatured = metadata.projects[b[0]]?.featured || false;
                    if (aFeatured !== bFeatured) return bFeatured - aFeatured;
                    return a[1].title.localeCompare(b[1].title);
                });

            document.getElementById('projectCount').textContent = projects.length;

            list.innerHTML = projects.map(([slug, project]) => {
                const meta = metadata.projects[slug] || {};
                const thumbPath = `gen/thumbnails/${project.path}`;
                const isEmpty = project.images === 0;
                return `
                    <div class="project-item ${currentProject === slug ? 'active' : ''} ${isEmpty ? 'empty-project' : ''}" onclick="selectProject('${slug}')">
                        <img class="project-thumb" src="${thumbPath}/.thumb.jpg"
                             onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2248%22 height=%2248%22%3E%3Crect fill=%22%23e2e8f0%22 width=%2248%22 height=%2248%22/%3E%3C/svg%3E'"
                             alt="${project.title}">
                        <div class="project-info">
                            <h4>${project.title}</h4>
                            <span>${isEmpty ? 'No images yet' : `${project.images} images`} • ${project.year}</span>
                        </div>
                        ${meta.featured ? '<span class="featured-badge">Featured</span>' : ''}
                        ${isEmpty ? '<span class="empty-badge">Empty</span>' : ''}
                    </div>
                `;
            }).join('');
        }

        // Featured Order Functions
        function renderFeaturedOrder() {
            const list = document.getElementById('featuredOrderList');
            const select = document.getElementById('addFeaturedSelect');

            // Get featured order from metadata
            const featuredOrder = metadata.featuredOrder || [];

            document.getElementById('featuredCount').textContent = featuredOrder.length;

            if (featuredOrder.length === 0) {
                list.innerHTML = '<div class="featured-order-empty">No featured projects<br><small>Use the dropdown below to add projects</small></div>';
            } else {
                list.innerHTML = featuredOrder.map((slug, idx) => {
                    const project = siteIndex.projects[slug];
                    const meta = metadata.projects[slug];
                    const title = meta?.title || project?.title || slug;
                    return `
                        <div class="featured-order-item" draggable="true" data-slug="${slug}">
                            <span class="drag-handle">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                    <circle cx="9" cy="6" r="2"/><circle cx="15" cy="6" r="2"/>
                                    <circle cx="9" cy="12" r="2"/><circle cx="15" cy="12" r="2"/>
                                    <circle cx="9" cy="18" r="2"/><circle cx="15" cy="18" r="2"/>
                                </svg>
                            </span>
                            <span class="order-num">${idx + 1}</span>
                            <span class="order-title">${title}</span>
                            <button class="remove-btn" onclick="removeFromFeatured('${slug}')" title="Remove from featured">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                            </button>
                        </div>
                    `;
                }).join('');

                // Initialize drag and drop for featured items
                initFeaturedDragDrop();
            }

            // Populate dropdown with non-featured projects
            const availableProjects = Object.entries(siteIndex.projects)
                .filter(([slug]) => !featuredOrder.includes(slug))
                .sort((a, b) => a[1].title.localeCompare(b[1].title));

            select.innerHTML = '<option value="">+ Add to Featured...</option>' +
                availableProjects.map(([slug, project]) => {
                    const meta = metadata.projects[slug];
                    const title = meta?.title || project.title;
                    return `<option value="${slug}">${title}</option>`;
                }).join('');
        }

        function renderTemplateSelector() {
            const grid = document.getElementById('templateGrid');
            const themeLabel = document.getElementById('currentTheme');

            themeLabel.textContent = templateConfigs[currentTemplate]?.name || 'Default';

            grid.innerHTML = Object.entries(templateConfigs).map(([key, config]) => {
                const isActive = key === currentTemplate;
                const [primary, secondary, bg] = config.colors;
                return `
                    <div class="template-card ${isActive ? 'active' : ''}" onclick="selectTemplate('${key}')">
                        <div class="template-preview">
                            <div class="color-bar" style="background: ${primary}"></div>
                            <div class="color-bar" style="background: ${secondary}"></div>
                            <div class="color-bar" style="background: ${bg}; border: 1px solid #e2e8f0;"></div>
                        </div>
                        <div class="template-name">${config.name}</div>
                    </div>
                `;
            }).join('');
        }

        async function selectTemplate(templateKey) {
            if (templateKey === currentTemplate) return;

            try {
                const res = await fetch('/api/template', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Password': password
                    },
                    body: JSON.stringify({ template: templateKey })
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.error || 'Failed to save template');
                }

                currentTemplate = templateKey;
                metadata.siteSettings = metadata.siteSettings || {};
                metadata.siteSettings.template = templateKey;
                renderTemplateSelector();
                showToast(`Theme changed to ${templateConfigs[templateKey].name}. Run Build to apply!`, 'success');
            } catch (error) {
                console.error('Failed to save template:', error);
                showToast(error.message, 'error');
            }
        }

        function initFeaturedDragDrop() {
            const items = document.querySelectorAll('.featured-order-item');
            let draggedItem = null;

            items.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedItem = item;
                    item.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });

                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                    draggedItem = null;
                    updateFeaturedOrderNumbers();
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';

                    if (draggedItem && draggedItem !== item) {
                        const list = document.getElementById('featuredOrderList');
                        const allItems = [...list.querySelectorAll('.featured-order-item')];
                        const draggedIdx = allItems.indexOf(draggedItem);
                        const targetIdx = allItems.indexOf(item);

                        if (draggedIdx < targetIdx) {
                            item.parentNode.insertBefore(draggedItem, item.nextSibling);
                        } else {
                            item.parentNode.insertBefore(draggedItem, item);
                        }
                    }
                });

                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    saveFeaturedOrder();
                });
            });
        }

        function updateFeaturedOrderNumbers() {
            const items = document.querySelectorAll('.featured-order-item');
            items.forEach((item, idx) => {
                const numEl = item.querySelector('.order-num');
                if (numEl) numEl.textContent = idx + 1;
            });
        }

        function saveFeaturedOrder() {
            const items = document.querySelectorAll('.featured-order-item');
            const newOrder = [...items].map(item => item.dataset.slug);

            metadata.featuredOrder = newOrder;

            // Update featured flag in each project
            Object.keys(metadata.projects).forEach(slug => {
                metadata.projects[slug].featured = newOrder.includes(slug);
            });

            document.getElementById('featuredCount').textContent = newOrder.length;
            hasChanges = true;
            updateChangeIndicator();
            renderProjectList(); // Update badges in project list
        }

        function addToFeatured(slug) {
            if (!slug) return;

            if (!metadata.featuredOrder) {
                metadata.featuredOrder = [];
            }

            if (!metadata.featuredOrder.includes(slug)) {
                metadata.featuredOrder.push(slug);

                // Mark as featured in project metadata
                if (!metadata.projects[slug]) {
                    metadata.projects[slug] = {};
                }
                metadata.projects[slug].featured = true;

                hasChanges = true;
                updateChangeIndicator();
                renderFeaturedOrder();
                renderProjectList();
                showToast('Added to featured!', 'success');
            }

            // Reset dropdown
            document.getElementById('addFeaturedSelect').value = '';
        }

        function removeFromFeatured(slug) {
            if (!metadata.featuredOrder) return;

            metadata.featuredOrder = metadata.featuredOrder.filter(s => s !== slug);

            // Remove featured flag
            if (metadata.projects[slug]) {
                metadata.projects[slug].featured = false;
            }

            hasChanges = true;
            updateChangeIndicator();
            renderFeaturedOrder();
            renderProjectList();
            showToast('Removed from featured', 'info');
        }

        async function selectProject(slug) {
            if (hasChanges) {
                if (!confirm('You have unsaved changes. Discard them?')) {
                    return;
                }
            }

            currentProject = slug;
            hasChanges = false;
            updateChangeIndicator();

            // Get project from siteIndex or create stub for empty projects
            const project = siteIndex.projects[slug] || {
                title: metadata.projects[slug]?.title || slug,
                year: metadata.projects[slug]?.year || '2024',
                path: slug,
                images: 0
            };
            const meta = metadata.projects[slug] || metadata.defaults;

            // Update UI
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('projectEditor').style.display = 'block';
            document.getElementById('deleteProjectBtn').disabled = false;

            // Fill metadata form
            document.getElementById('projectTitle').value = meta.title || project.title;
            document.getElementById('projectYear').value = meta.year || project.year;
            document.getElementById('projectTags').value = meta.tags || '';
            document.getElementById('projectCategory').value = meta.category || 'makers';
            document.getElementById('projectDescription').value = meta.description || '';
            document.getElementById('projectFeatured').checked = meta.featured || false;

            // Load gallery images
            await loadGalleryImages(slug);

            // Initialize upload zone
            initUploadZone();

            // Update project list to show active
            renderProjectList();

            // Add change listeners
            ['projectTitle', 'projectYear', 'projectTags', 'projectCategory', 'projectDescription', 'projectFeatured'].forEach(id => {
                const el = document.getElementById(id);
                el.onchange = el.oninput = markChanged;
            });
        }

        async function loadGalleryImages(slug) {
            const project = siteIndex.projects[slug];
            const grid = document.getElementById('galleryGrid');

            // Handle empty projects (not in siteIndex)
            if (!project || !project.manifest) {
                grid.innerHTML = '<p class="empty-gallery-message">No images yet. Upload images using the form above.</p>';
                document.getElementById('imageCount').textContent = '0 images';
                return;
            }

            const manifestPath = project.manifest;

            try {
                const res = await fetch(manifestPath);
                const manifest = await res.json();

                let images = manifest.images;

                // Apply custom order if exists
                if (imageOrder[slug]) {
                    const order = imageOrder[slug];
                    images = images.sort((a, b) => {
                        const aIdx = order.indexOf(a);
                        const bIdx = order.indexOf(b);
                        if (aIdx === -1) return 1;
                        if (bIdx === -1) return -1;
                        return aIdx - bIdx;
                    });
                }

                const thumbPath = `gen/thumbnails/${project.path}`;
                const imagePath = `images/${project.path}`;

                grid.innerHTML = images.map((img, idx) => {
                    const thumbName = img.replace(/\.(jpg|jpeg|png|JPG|JPEG|PNG)$/i, '.jpg');
                    return `
                        <div class="gallery-item" draggable="true" data-image="${img}">
                            <span class="gallery-item-index">${idx + 1}</span>
                            <button class="gallery-item-delete" onclick="deleteImage('${img}')" title="Delete image">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                            </button>
                            <img src="${thumbPath}/${thumbName}"
                                 onerror="this.src='${imagePath}/${img}'"
                                 alt="${img}">
                            <div class="gallery-item-overlay">${img}</div>
                        </div>
                    `;
                }).join('');

                document.getElementById('imageCount').textContent = `${images.length} images`;

                // Initialize drag and drop
                initDragDrop();

            } catch (error) {
                console.error('Failed to load gallery:', error);
                grid.innerHTML = '<p class="empty-gallery-message">No images yet. Upload images using the form above.</p>';
                document.getElementById('imageCount').textContent = '0 images';
            }
        }

        function initDragDrop() {
            const items = document.querySelectorAll('.gallery-item');
            let draggedItem = null;

            items.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedItem = item;
                    item.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });

                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                    document.querySelectorAll('.gallery-item').forEach(i => i.classList.remove('drag-over'));
                    updateImageOrder();
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    if (item !== draggedItem) {
                        item.classList.add('drag-over');
                    }
                });

                item.addEventListener('dragleave', () => {
                    item.classList.remove('drag-over');
                });

                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (item !== draggedItem) {
                        const grid = document.getElementById('galleryGrid');
                        const allItems = [...grid.querySelectorAll('.gallery-item')];
                        const draggedIdx = allItems.indexOf(draggedItem);
                        const dropIdx = allItems.indexOf(item);

                        if (draggedIdx < dropIdx) {
                            item.after(draggedItem);
                        } else {
                            item.before(draggedItem);
                        }

                        // Update index numbers
                        grid.querySelectorAll('.gallery-item').forEach((item, idx) => {
                            item.querySelector('.gallery-item-index').textContent = idx + 1;
                        });

                        markChanged();
                    }
                });
            });
        }

        function updateImageOrder() {
            const grid = document.getElementById('galleryGrid');
            const items = grid.querySelectorAll('.gallery-item');
            const order = [...items].map(item => item.dataset.image);
            imageOrder[currentProject] = order;
        }

        function markChanged() {
            hasChanges = true;
            updateChangeIndicator();
        }

        function updateChangeIndicator() {
            document.getElementById('changeIndicator').style.display = hasChanges ? 'inline-flex' : 'none';
            document.getElementById('saveBtn').disabled = !hasChanges;
        }

        async function saveChanges() {
            if (!currentProject) return;

            // Update metadata
            if (!metadata.projects[currentProject]) {
                metadata.projects[currentProject] = {};
            }

            const meta = metadata.projects[currentProject];
            meta.title = document.getElementById('projectTitle').value;
            meta.year = document.getElementById('projectYear').value;
            meta.tags = document.getElementById('projectTags').value;
            meta.category = document.getElementById('projectCategory').value;
            meta.description = document.getElementById('projectDescription').value;
            meta.featured = document.getElementById('projectFeatured').checked;

            try {
                // Save metadata via API
                const res = await fetch('/api/metadata', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password, metadata })
                });

                if (!res.ok) {
                    throw new Error('Failed to save metadata');
                }

                // Save image order locally
                localStorage.setItem('imageOrders', JSON.stringify(imageOrder));

                // Also save image order via API if we have a custom order
                if (imageOrder[currentProject]) {
                    await fetch('/api/image-order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            password,
                            project: currentProject,
                            order: imageOrder[currentProject]
                        })
                    });
                }

                hasChanges = false;
                updateChangeIndicator();
                renderProjectList();
                showToast('Changes saved successfully!', 'success');

            } catch (error) {
                console.error('Failed to save:', error);
                showToast('Failed to save changes', 'error');
            }
        }

        async function triggerBuild() {
            const btn = document.getElementById('buildBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Building...';

            try {
                const res = await fetch('/api/build', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || 'Build failed');
                }

                showToast('Build started!', 'success');

            } catch (error) {
                showToast(error.message, 'error');
                btn.disabled = false;
                btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16,3 21,3 21,8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21,16 21,21 16,21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/></svg> Build Site';
            }
        }

        function startStatusPolling() {
            setInterval(async () => {
                try {
                    const res = await fetch('/api/build/status');
                    const status = await res.json();

                    const buildBtn = document.getElementById('buildBtn');
                    const statusEl = document.getElementById('buildStatus');
                    const outputEl = document.getElementById('buildOutput');
                    const lastTimeEl = document.getElementById('lastBuildTime');
                    const lastResultEl = document.getElementById('lastBuildResult');

                    if (status.running) {
                        buildBtn.disabled = true;
                        buildBtn.innerHTML = '<span class="spinner"></span> Building...';
                        statusEl.textContent = 'Building...';
                        statusEl.style.color = 'var(--warning)';
                    } else {
                        buildBtn.disabled = false;
                        buildBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16,3 21,3 21,8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21,16 21,21 16,21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/></svg> Build Site';
                        statusEl.textContent = 'Ready';
                        statusEl.style.color = 'var(--success)';
                    }

                    if (status.last_run) {
                        lastTimeEl.textContent = new Date(status.last_run * 1000).toLocaleString();
                    }

                    if (status.last_result) {
                        lastResultEl.textContent = status.last_result.success ? 'Success' : 'Failed';
                        lastResultEl.style.color = status.last_result.success ? 'var(--success)' : 'var(--danger)';
                    }

                    if (status.output) {
                        outputEl.textContent = status.output;
                        outputEl.scrollTop = outputEl.scrollHeight;
                    }

                } catch (error) {
                    console.error('Status poll failed:', error);
                }
            }, 2000);
        }

        function previewSite() {
            window.open('/', '_blank');
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Upload functionality
        function initUploadZone() {
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');

            // Drag and drop events
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('drag-over');
            });

            uploadZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('drag-over');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('drag-over');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    uploadFiles(files);
                }
            });

            // File input change
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    uploadFiles(e.target.files);
                }
            });
        }

        async function uploadFiles(files) {
            if (!currentProject) {
                showToast('Please select a project first', 'error');
                return;
            }

            const project = siteIndex.projects[currentProject];
            if (!project) {
                showToast('Project not found', 'error');
                return;
            }

            const uploadZone = document.getElementById('uploadZone');
            const uploadProgress = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('progressFill');

            uploadZone.classList.add('uploading');
            uploadProgress.classList.add('visible');
            progressFill.style.width = '0%';

            const formData = new FormData();
            formData.append('password', password);
            formData.append('project_path', project.path);

            for (const file of files) {
                formData.append('images', file);
            }

            try {
                progressFill.style.width = '50%';

                const res = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                progressFill.style.width = '100%';

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || 'Upload failed');
                }

                if (data.uploaded.length > 0) {
                    showToast(`Uploaded ${data.uploaded.length} image(s)!`, 'success');
                    // Reload the gallery after a short delay
                    setTimeout(() => loadGalleryImages(currentProject), 500);
                }

                if (data.errors.length > 0) {
                    showToast(`${data.errors.length} file(s) failed: ${data.errors[0]}`, 'error');
                }

            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                uploadZone.classList.remove('uploading');
                setTimeout(() => {
                    uploadProgress.classList.remove('visible');
                    progressFill.style.width = '0%';
                }, 1000);
                // Clear file input
                document.getElementById('fileInput').value = '';
            }
        }

        // Project Management Functions
        function showNewProjectModal() {
            document.getElementById('newProjectModal').classList.add('visible');
            document.getElementById('newProjectTitle').value = '';
            document.getElementById('newProjectSlug').value = '';
            document.getElementById('newProjectYear').value = new Date().getFullYear();
            document.getElementById('newProjectTitle').focus();
        }

        function closeNewProjectModal() {
            document.getElementById('newProjectModal').classList.remove('visible');
        }

        // Auto-generate slug from title
        document.addEventListener('DOMContentLoaded', () => {
            const titleInput = document.getElementById('newProjectTitle');
            const slugInput = document.getElementById('newProjectSlug');
            if (titleInput && slugInput) {
                titleInput.addEventListener('input', () => {
                    slugInput.value = titleInput.value
                        .toLowerCase()
                        .replace(/[^a-z0-9]+/g, '-')
                        .replace(/^-|-$/g, '');
                });
            }
        });

        async function createNewProject() {
            const title = document.getElementById('newProjectTitle').value.trim();
            const slug = document.getElementById('newProjectSlug').value.trim();
            const category = document.getElementById('newProjectCategory').value;
            const year = document.getElementById('newProjectYear').value.trim();

            if (!title) {
                showToast('Please enter a project title', 'error');
                return;
            }

            if (!slug) {
                showToast('Please enter a folder name', 'error');
                return;
            }

            // Validate slug format
            if (!/^[a-z0-9-]+$/.test(slug)) {
                showToast('Folder name can only contain lowercase letters, numbers, and hyphens', 'error');
                return;
            }

            try {
                const res = await fetch('/api/create-project', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        password,
                        title,
                        slug,
                        category,
                        year
                    })
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || 'Failed to create project');
                }

                closeNewProjectModal();
                showToast('Project created! Run Build to update site.', 'success');

                // Reload data
                const metaRes = await fetch('/projects-metadata.json');
                metadata = await metaRes.json();
                renderProjectList();
                renderFeaturedOrder();

            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function deleteCurrentProject() {
            if (!currentProject) {
                showToast('No project selected', 'error');
                return;
            }

            const project = siteIndex.projects[currentProject];
            const title = metadata.projects[currentProject]?.title || project?.title || currentProject;

            if (!confirm(`Delete "${title}"?\n\nThis will permanently delete:\n- All images in this project\n- All thumbnails\n- The project page\n\nThis cannot be undone!`)) {
                return;
            }

            // Double confirm for safety
            if (!confirm('Are you REALLY sure? Type "delete" in the next prompt to confirm.')) {
                return;
            }

            const confirmText = prompt('Type "delete" to confirm:');
            if (confirmText !== 'delete') {
                showToast('Deletion cancelled', 'info');
                return;
            }

            try {
                const res = await fetch('/api/delete-project', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        password,
                        slug: currentProject
                    })
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || 'Failed to delete project');
                }

                showToast('Project deleted!', 'success');

                // Clear selection
                currentProject = null;
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('projectEditor').style.display = 'none';
                document.getElementById('deleteProjectBtn').disabled = true;

                // Reload data
                const indexRes = await fetch('/gen/site-index.json');
                siteIndex = await indexRes.json();
                const metaRes = await fetch('/projects-metadata.json');
                metadata = await metaRes.json();
                renderProjectList();
                renderFeaturedOrder();

            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function deleteImage(imageName) {
            if (!currentProject) {
                showToast('No project selected', 'error');
                return;
            }

            // Confirm deletion
            if (!confirm(`Delete "${imageName}"?\n\nThis will permanently remove the image and its thumbnail.`)) {
                return;
            }

            const project = siteIndex.projects[currentProject];
            if (!project) {
                showToast('Project not found', 'error');
                return;
            }

            try {
                const res = await fetch('/api/delete-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        password,
                        project_path: project.path,
                        image_name: imageName
                    })
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || 'Delete failed');
                }

                showToast('Image deleted!', 'success');

                // Remove from image order if present
                if (imageOrder[currentProject]) {
                    imageOrder[currentProject] = imageOrder[currentProject].filter(img => img !== imageName);
                }

                // Reload the gallery
                await loadGalleryImages(currentProject);

            } catch (error) {
                showToast(error.message, 'error');
            }
        }
    </script>
</body>
</html>
